<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voting System ‚Äî Dashboard</title>
  <style>
    :root {
      --bg: #121417;
      --header-bg: #1d1f23;
      --header-text: #f2f2f2;
      --card-bg: #1a1c20;
      --text: #eaeaea;
      --accent: #4e9eff;
      --border: #2b2d32;
      --shadow: rgba(0, 0, 0, 0.6);
      --muted: #9aa3ad;
    }

    body {
      font-family: "Inter", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
    }

    /* ===== HEADER ===== */
    header {
      background: var(--header-bg);
      color: var(--header-text);
      padding: 14px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo { font-weight: 800; font-size: 20px; color: var(--accent); }
    .menu { position: relative; display: flex; align-items: center; gap: 18px; }
    .menu-links { display: flex; gap: 18px; align-items: center; }
    .menu-links a {
      text-decoration: none;
      color: var(--header-text);
      font-weight: 500;
      font-size: 15px;
      transition: opacity 0.2s ease;
    }
    .menu-links a:hover { opacity: 0.7; }
    .menu-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 6px;
    }
    .menu-btn div {
      width: 22px; height: 2px; background: var(--header-text);
      margin: 5px 0; transition: 0.3s;
    }
    .dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: 42px;
      background: #23262b;
      border-radius: 6px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
      min-width: 160px;
      overflow: hidden;
      z-index: 999;
    }
    .dropdown a {
      display: block;
      padding: 10px 14px;
      text-decoration: none;
      color: #eaeaea;
      font-size: 14px;
      transition: background 0.2s ease;
    }
    .dropdown a:hover { background: #2e3238; }
    .show { display: block; }

    /* ===== BODY ===== */
    .container {
      max-width: 1000px;
      margin: 30px auto;
      padding: 0 20px;
    }

    .hero {
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .welcome-large {
      font-size: 40px;
      font-weight: 800;
      color: #fff;
      margin-bottom: 4px;
    }
    .welcome-sub { color: var(--muted); font-size: 15px; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 18px;
      margin-top: 18px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 22px;
      box-shadow: 0 1px 8px var(--shadow);
      transition: transform 0.18s ease, box-shadow 0.18s ease;
      min-height: 160px;
    }
    .card:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.45); }

    .card h3 {
      margin: 0 0 10px;
      font-size: 18px;
      color: var(--accent);
    }

    .summary-list {
      margin: 8px 0 0;
      color: #c9d2db;
      font-size: 14px;
      line-height: 1.6;
      list-style: none;
      padding: 0;
    }

    .small-muted {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 8px;
    }

    .vote-action {
      display: block;
      padding: 14px 18px;
      background: linear-gradient(90deg, #4e9eff 0%, #2a7bd6 100%);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 700;
      text-align: center;
      box-shadow: 0 6px 16px rgba(46,125,246,0.16);
      transition: transform 0.12s ease;
      margin-top: 12px;
    }
    .disabled-link {
        background: #6c757d !important;
        cursor: not-allowed !important;
        pointer-events: none !important;
        opacity: 0.6 !important;
    }
    .vote-action:active { transform: translateY(1px); }

    .chart {
      background: linear-gradient(120deg, #4e9eff 0%, #36c97e 100%);
      color: #fff;
      border-radius: 8px;
      padding: 35px;
      text-align: center;
      font-size: 16px;
      font-weight: 600;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
      margin-top: 25px;
    }

    @media (max-width: 720px) {
      .welcome-large { font-size: 32px; }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <header>
    <div class="logo">VoteEase</div>
    <div class="menu">
      <div class="menu-links"></div>
      <button class="menu-btn" onclick="toggleMenu()">
        <div></div><div></div><div></div>
      </button>
      <div class="dropdown" id="dropdownMenu">
        <a href="public/user/profile.html">Profile</a>
        <a href="public/user/contactus.html">Contact Us</a>
        <a href="public/user/about.html">About</a>
        <a href="public/user/privacypolicy.html">Privacy Policy</a>
        <a href="index.html" onclick="logout()">Logout</a>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div>
        <div id="welcomeLarge" class="welcome-large">Welcome, John</div>
        <div id="welcomeSub" class="welcome-sub">Good to see you ‚Äî John.</div>
      </div>
    </section>

    <section class="grid">
     <div class="card">
    <h3>Vote</h3>
    <p class="small-muted" id="voteStatusText">Cast your vote for the active election. Review candidates before confirming.</p>
    <ul class="summary-list">
        <li><strong>Active Election:</strong> <span id="electionTitle">Loading...</span></li>
        <li><strong>Polling Period:</strong> <span id="pollingPeriod">Loading...</span></li>
        <li><strong>Status:</strong> <span id="votingStatus">Loading...</span></li>
    </ul>
    <a href="public/user/vote.html" class="vote-action" id="voteButton">Start Voting</a>
</div>

      <div class="card">
    <h3>Summary</h3>
    <p class="small-muted">Your voting summary for the current election.</p>
    <ul class="summary-list" id="voteSummaryList">
        <li><strong>President:</strong> <span id="presidentVote">Not voted yet</span></li>
        <li><strong>Vice President:</strong> <span id="vicePresidentVote">Not voted yet</span></li>
        <li><strong>Secretary:</strong> <span id="secretaryVote">Not voted yet</span></li>
        <li><strong>Treasurer:</strong> <span id="treasurerVote">Not voted yet</span></li>
        <li><strong>Auditor:</strong> <span id="auditorVote">Not voted yet</span></li>
    </ul>
    <p class="small-muted" id="voteDate" style="margin-top:10px;">Not voted yet</p>
</div>

    <section>
      <div class="chart">
        üèÜ <strong>Top Candidate:</strong> Liza Ramos (27 votes)<br>
        ‚öôÔ∏è <strong>Least Votes:</strong> Carl Mendoza (8 votes)
      </div>
    </section>
  </main>

  <script>
// WORKING VERSION - COMPLETELY BLOCKS ACCESS TO VOTE.HTML
let userHasVoted = localStorage.getItem('hasVoted') === 'true';
let canUserVote = false;

window.onload = function() {
    const user = JSON.parse(localStorage.getItem("user"));
    if (user && user.name) {
        let firstName = user.name.trim().split(" ")[0];
        if (firstName.includes(",")) {
            firstName = user.name.split(",")[1]?.trim().split(" ")[0] || firstName;
        }
        firstName = firstName.charAt(0).toUpperCase() + firstName.slice(1).toLowerCase();

        document.getElementById("welcomeLarge").textContent = `Welcome, ${firstName}`;
        document.getElementById("welcomeSub").textContent = `Good to see you ‚Äî ${firstName}.`;
        
        loadEverything();
    } else {
        window.location.href = "index.html";
    }
};

function loadEverything() {
    loadElectionInfo();
    loadVoteSummary();
    checkVoteStatus();
}



function loadElectionInfo() {
    fetch('/voting_system/backend/get_election_settings.php')
        .then(response => response.json())
        .then(data => {
            console.log('üìä ELECTION SETTINGS RESPONSE:', data); // DEBUG
            
            if (data.success && data.settings) {
                const settings = data.settings;
                
                document.getElementById('electionTitle').textContent = settings.election_title;
                
                const startDate = new Date(settings.start_date);
                const endDate = new Date(settings.end_date);
                
                const startDateStr = startDate.toLocaleDateString();
                const endDateStr = endDate.toLocaleDateString();
                document.getElementById('pollingPeriod').textContent = `${startDateStr} - ${endDateStr}`;
                
                // FIX: Use the is_voting_active flag from server directly
                const isVotingActive = settings.is_voting_active === true || settings.is_voting_active === 'true';
                console.log('üéØ VOTING ACTIVE STATUS:', isVotingActive);
                
                updateVotingStatus(isVotingActive);
            } else {
                console.error('‚ùå No election settings found');
            }
        })
        .catch(error => {
            console.error('Error loading election info:', error);
        });
}



function checkVoteStatus() {
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user || !user.id) return;

    fetch(`/voting_system/backend/get_user_votes.php?user_id=${user.id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const hasVotesInDB = Object.keys(data.votes || {}).length > 0;
                
                // Sync with database
                if (!hasVotesInDB && userHasVoted) {
                    localStorage.removeItem('hasVoted');
                    localStorage.removeItem('userVote');
                    userHasVoted = false;
                    loadVoteSummary();
                    refreshVotingUI();
                } else if (hasVotesInDB && !userHasVoted) {
                    localStorage.setItem('hasVoted', 'true');
                    localStorage.setItem('userVote', JSON.stringify(data.votes));
                    userHasVoted = true;
                    loadVoteSummary();
                    refreshVotingUI();
                }
            }
        })
        .catch(error => {
            console.error('Error checking vote status:', error);
        });
}

function updateVotingStatus(isVotingActive) {
    const voteButton = document.getElementById('voteButton');
    const votingStatus = document.getElementById('votingStatus');
    const voteStatusText = document.getElementById('voteStatusText');

    // Reset button
    voteButton.classList.remove('disabled-link');
    voteButton.onclick = null;
    voteButton.href = 'public/user/vote.html';

    if (userHasVoted) {
        votingStatus.textContent = 'Already Voted';
        votingStatus.style.color = '#36c97e';
        voteButton.textContent = 'Already Voted';
        voteButton.classList.add('disabled-link');
        voteButton.href = '#';
        voteButton.onclick = function(e) {
            e.preventDefault();
            alert('You have already voted in this election.');
        };
        voteStatusText.textContent = 'You have already cast your vote.';
    } else {
        if (isVotingActive) {
            votingStatus.textContent = 'Open for Voting';
            votingStatus.style.color = '#36c97e';
            voteButton.textContent = 'Start Voting';
            voteButton.style.background = 'linear-gradient(90deg, #4e9eff 0%, #2a7bd6 100%)';
            voteButton.style.cursor = 'pointer';
            voteButton.onclick = null;
            voteButton.href = 'public/user/vote.html';
            voteStatusText.textContent = 'Cast your vote for the active election. Review candidates before confirming.';
        } else {
            votingStatus.textContent = 'Voting Closed';
            votingStatus.style.color = '#ff6b6b';
            voteButton.textContent = 'Voting Closed';
            voteButton.classList.add('disabled-link');
            voteButton.href = '#';
            voteButton.onclick = function(e) {
                e.preventDefault();
                alert('Voting is currently closed. Please contact the administrator.');
            };
            voteStatusText.textContent = 'Voting is currently closed. Check back later.';
        }
    }
}

function refreshVotingUI() {
    fetch('/voting_system/backend/get_election_settings.php')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.settings) {
                const startDate = new Date(data.settings.start_date);
                const endDate = new Date(data.settings.end_date);
                const now = new Date();
                const isVotingActive = (now >= startDate && now <= endDate);
                updateVotingStatus(isVotingActive);
            }
        });
}

function loadVoteSummary() {
    const localVotes = JSON.parse(localStorage.getItem('userVote') || '{}');
    userHasVoted = localStorage.getItem('hasVoted') === 'true';
    
    if (userHasVoted && Object.keys(localVotes).length > 0) {
        displayVoteSummary(localVotes);
    } else {
        clearVoteSummary();
    }
}

function displayVoteSummary(votes) {
    const positions = {
        'President': 'presidentVote',
        'Vice President': 'vicePresidentVote', 
        'Secretary': 'secretaryVote',
        'Treasurer': 'treasurerVote',
        'Auditor': 'auditorVote'
    };
    
    for (const [position, candidateName] of Object.entries(votes)) {
        if (positions[position]) {
            document.getElementById(positions[position]).textContent = candidateName;
        }
    }
    
    document.getElementById('voteDate').textContent = `Vote recorded: ${new Date().toLocaleDateString()}`;
}

function clearVoteSummary() {
    document.getElementById('presidentVote').textContent = 'Not voted yet';
    document.getElementById('vicePresidentVote').textContent = 'Not voted yet';
    document.getElementById('secretaryVote').textContent = 'Not voted yet';
    document.getElementById('treasurerVote').textContent = 'Not voted yet';
    document.getElementById('auditorVote').textContent = 'Not voted yet';
    document.getElementById('voteDate').textContent = 'Not voted yet';
}

function toggleMenu() {
    document.getElementById("dropdownMenu").classList.toggle("show");
}

window.onclick = function(e) {
    if (!e.target.matches('.menu-btn') && !e.target.closest('.menu')) {
        document.getElementById("dropdownMenu").classList.remove("show");
    }
};

function logout() {
    localStorage.removeItem("user");
    localStorage.removeItem("userVote");
    localStorage.removeItem("hasVoted");
    window.location.href = "index.html";
}

// Auto-refresh every 3 seconds
setInterval(loadEverything, 3000);
</script>
</body>
</html>