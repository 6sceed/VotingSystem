<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Voting Assistance — Admin Dashboard</title>
    <style>
        :root{
            --bg: #0f172a;
            --card: #1e293b;
            --accent: #3b82f6;
            --accent-dark: #1d4ed8;
            --muted: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #334155;
            --sidebar: #0f172a;
            --sidebar-hover: #1e293b;
            --sidebar-text: #f1f5f9;
            --text: #f8fafc;
        }
        
        *{
            box-sizing:border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body{
            margin:0;
            background:var(--bg);
            color:var(--text);
            line-height:1.6;
        }
        
        body.modal-open { 
            overflow: hidden; 
        }
        
        /* Header */
        header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:16px 24px;
            background:var(--card);
            border-bottom:1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        header h1{
            font-size:18px;
            font-weight:600;
            margin:0;
            color:var(--text);
        }
        
        /* Layout */
        .layout{
            display:grid;
            grid-template-columns:240px 1fr;
            min-height:calc(100vh - 64px);
        }
        
        /* Sidebar Navigation */
        nav{
            padding:24px 0;
            background:var(--sidebar);
            border-right:1px solid var(--border);
        }
        
        .nav-item{
            display:flex;
            align-items:center;
            gap:12px;
            padding:12px 20px;
            color:var(--sidebar-text);
            text-decoration:none;
            margin-bottom:4px;
            transition: all 0.2s ease;
            font-weight:500;
        }
        
        .nav-item:hover{
            background:var(--sidebar-hover);
        }
        
        .nav-item.active{
            background:var(--accent);
            color:white;
            border-right:3px solid var(--accent-dark);
        }
        
        .nav-item i{
            width:20px;
            text-align:center;
        }
        
        /* Main Content */
        main{
            padding:24px;
            background:var(--bg);
        }
        
        /* Cards */
        .card{
            background:var(--card);
            padding:24px;
            border-radius:12px;
            box-shadow:0 1px 3px rgba(0,0,0,0.3);
            border:1px solid var(--border);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover{
            transform:translateY(-2px);
            box-shadow:0 4px 12px rgba(0,0,0,0.4);
        }
        
        .row{
            display:flex;
            gap:20px;
            flex-wrap:wrap;
        }
        
        .stat{
            flex:1;
            min-width:180px;
            text-align:center;
        }
        
        .stat h3{
            margin:0;
            font-size:14px;
            color:var(--muted);
            font-weight:500;
            text-transform:uppercase;
            letter-spacing:0.5px;
        }
        
        .stat p{
            margin:8px 0 0;
            font-size:28px;
            font-weight:700;
            color:var(--text);
        }
        
        /* Buttons */
        .controls{
            display:flex;
            gap:12px;
            align-items:center;
        }
        
        button{
            border:0;
            padding:10px 16px;
            border-radius:8px;
            background:var(--accent);
            color:#fff;
            cursor:pointer;
            font-weight:600;
            font-size:14px;
            transition:all 0.2s ease;
        }
        
        button:hover{
            background:var(--accent-dark);
            transform:translateY(-1px);
        }
        
        button.secondary{
            background:#374151;
            color:#d1d5db;
            border:1px solid var(--border);
        }
        
        button.secondary:hover{
            background:#4b5563;
            color:#f3f4f6;
        }
        
        button.success{
            background:var(--success);
        }
        
        button.success:hover{
            background:#059669;
        }
        
        button.danger{
            background:var(--danger);
        }
        
        button.danger:hover{
            background:#dc2626;
        }
        
        /* Tables */
        table{
            width:100%;
            border-collapse:collapse;
            margin-top:16px;
        }
        
        th{
            background:#1e293b;
            padding:12px 16px;
            text-align:left;
            font-weight:600;
            color:var(--muted);
            font-size:14px;
            border-bottom:2px solid var(--border);
        }
        
        td{
            padding:16px;
            border-bottom:1px solid var(--border);
            font-size:14px;
            color:var(--text);
        }
        
        tr:hover{
            background:#1e293b;
        }
        
        .muted{
            color:var(--muted);
        }
        
        .small{
            font-size:13px;
        }
        
        .actions{
            display:flex;
            gap:8px;
        }
        
        .actions button{
            padding:6px 12px;
            font-size:12px;
        }
        
        /* Badges */
        .badge{
            display:inline-block;
            padding:4px 12px;
            border-radius:20px;
            font-weight:600;
            font-size:12px;
        }
        
        .badge.success{
            background:#065f46;
            color:#d1fae5;
        }
        
        .badge.danger{
            background:#991b1b;
            color:#fee2e2;
        }
        
        .badge.warning{
            background:#92400e;
            color:#fef3c7;
        }
        
        .badge.muted{
            background:#374151;
            color:#d1d5db;
        }
        
        /* Forms */
        .form-group{
            margin-bottom:20px;
        }
        
        .form-group label{
            display:block;
            margin-bottom:8px;
            font-weight:500;
            color:var(--muted);
            font-size:14px;
        }
        
        .form-group input, .form-group select, .form-group textarea{
            width:100%;
            padding:12px;
            background:#0f172a;
            border:1px solid var(--border);
            border-radius:8px;
            font-size:14px;
            transition:border-color 0.2s ease;
            color:var(--text);
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus{
            outline:none;
            border-color:var(--accent);
            box-shadow:0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-group textarea{
            height:100px;
            resize:vertical;
        }
        
        /* Messages */
        .message{
            padding:16px;
            border-radius:8px;
            margin-bottom:20px;
            text-align:center;
            font-weight:500;
        }
        
        .success{
            background:#065f46;
            color:#d1fae5;
            border:1px solid #065f46;
        }
        
        .error{
            background:#991b1b;
            color:#fee2e2;
            border:1px solid #991b1b;
        }
        
        /* Election Controls */
        .election-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 20px;
        }
        
        /* Edit Styles */
        .editing-row { 
            background: #1e3a8a !important; 
        }
        
        .edit-input, .edit-select { 
            width: 100%; 
            padding: 8px 12px; 
            background: #0f172a;
            border: 1px solid var(--border); 
            border-radius: 6px; 
            font-size: 14px; 
            color: var(--text);
        }
        
        /* Modal Styles */
        .modal{
            position:fixed;
            inset:0;
            background:rgba(0, 0, 0, 0.8);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:1000;
            backdrop-filter: blur(4px);
        }
        
        .modal.open{
            display:flex;
        }
        
        .modal .card{
            width:480px;
            max-width:94%;
            max-height:90vh;
            overflow-y:auto;
            box-shadow:0 25px 50px rgba(0,0,0,0.5);
            border:none;
        }
        
        footer{
            padding:20px 24px;
            color:var(--muted);
            font-size:14px;
            background:var(--card);
            border-top:1px solid var(--border);
            text-align:center;
        }
        
        @media (max-width:768px){
            .layout{
                grid-template-columns:1fr;
            }
            
            nav{
                display:flex;
                overflow:auto;
                padding:16px;
            }
            
            .nav-item{
                white-space:nowrap;
                margin-bottom:0;
                margin-right:8px;
            }
            
            .row{
                flex-direction:column;
            }
            
            .stat{
                min-width:auto;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Voting System Admin Dashboard</h1>
        <div class="controls">
            <!-- Removed the toggle voting button from header -->
        </div>
    </header>

    <div class="layout">
        <nav aria-label="Main navigation">
            <a href="#" class="nav-item active" data-view="overview">
                Overview
            </a>
            <a href="#" class="nav-item" data-view="candidates">
                Election
            </a>
            <a href="#" class="nav-item" data-view="voters">
                Voters
            </a>
            <a href="#" class="nav-item" data-view="results">
                Results
            </a>
            <a href="#" class="nav-item" data-view="settings">
                Settings
            </a>
        </nav>

        <main>
            <!-- Overview -->
            <section id="view-overview" class="view">
                <div class="row">
                    <div class="card stat">
                        <h3>Total Voters</h3>
                        <p id="totalVoters">0</p>
                    </div>
                    <div class="card stat">
                        <h3>Total Candidates</h3>
                        <p id="totalCandidates">0</p>
                    </div>
                    <div class="card stat">
                        <h3>Total Votes Cast</h3>
                        <p id="totalVotes">0</p>
                    </div>
                </div>

                <div class="card" style="margin-top:24px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                        <h3 style="margin:0;color:var(--text);">Quick Actions</h3>
                        <div>
                            <button id="addCandidateBtn">Add Candidate</button>
                            <button id="addVoterBtn" class="secondary">Add Voter</button>
                        </div>
                    </div>
                    <p class="muted">Manage your voting system efficiently. Use the navigation to access different sections.</p>
                </div>
            </section>

            <!-- Candidates -->
            <section id="view-candidates" class="view" style="display:none">
                <!-- Election Configuration -->
                <div class="card" style="margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                        <h3 style="margin:0;color:var(--text);">Election Controls</h3>
                        <div class="election-controls">
                            <button id="startVotingBtn" class="success">Start Voting</button>
                            <button id="stopVotingBtn" class="danger" style="display:none;">Stop Voting</button>
                            <button id="resetAllBtn" class="danger" title="Reset all votes">Reset All Votes</button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label for="electionTitle">Election Title</label>
                            <input type="text" id="electionTitle" name="election_title" required placeholder="Enter election title">
                        </div>
                        <div class="form-group">
                            <label for="electionDescription">Description</label>
                            <input type="text" id="electionDescription" name="election_description" placeholder="Brief description">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 16px;">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="datetime-local" id="startDate" name="start_date" required>
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <input type="datetime-local" id="endDate" name="end_date" required>
                        </div>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:20px">
                        <div class="muted" id="electionStatus">Status: Not configured</div>
                        <button type="button" id="resetSettings" class="secondary">Reset Form</button>
                    </div>
                </div>

                <!-- Candidate Management -->
                <div class="card" style="margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <h3 style="margin:0;color:var(--text);">Candidate Management</h3>
                        <div>
                            <button id="addCandidateBtn2">Add New Candidate</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div id="candidateMessage"></div>
                    <table id="candidatesTable" aria-describedby="candidates">
                        <thead>
                            <tr><th>Candidate</th><th>Position</th><th>Status</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="candidatesTableBody">
                            <tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">Loading candidates...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Voters -->
            <section id="view-voters" class="view" style="display:none">
                <div class="card" style="margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <h3 style="margin:0;color:var(--text);">Registered Voters</h3>
                        <div>
                            <button id="addVoterBtn2">New Voter</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div id="voterMessage"></div>
                    <table id="votersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Has Voted</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="votersTableBody">
                            <tr><td colspan="5" style="text-align:center;padding:32px;color:var(--muted)">Loading voters...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Results -->
            <section id="view-results" class="view" style="display:none">
                <div class="card" style="margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <h3 style="margin:0;color:var(--text);">Live Results</h3>
                        <div>
                            <button id="exportResultsBtn" class="secondary">Export Results</button>
                        </div>
                    </div>
                </div>

                <div id="resultsList" class="card"></div>
            </section>

            <!-- Settings -->
            <section id="view-settings" class="view" style="display:none">
                <div class="card" style="margin-bottom:20px">
                    <h3 style="margin:0;color:var(--text);">Election Configuration</h3>
                    <p class="muted">Configure the current election settings.</p>
                </div>

                <div class="card">
                    <form id="electionSettingsForm">
                        <div class="form-group">
                            <label for="settingsElectionTitle">Election Title</label>
                            <input type="text" id="settingsElectionTitle" name="election_title" required placeholder="Enter election title">
                        </div>
                        <div class="form-group">
                            <label for="settingsElectionDescription">Description</label>
                            <textarea id="settingsElectionDescription" name="election_description" placeholder="Brief description about the election"></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label for="settingsStartDate">Start Date</label>
                                <input type="datetime-local" id="settingsStartDate" name="start_date" required>
                            </div>
                            <div class="form-group">
                                <label for="settingsEndDate">End Date</label>
                                <input type="datetime-local" id="settingsEndDate" name="end_date" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <input type="checkbox" id="isActive" name="is_active" style="width: auto;">
                                <span>Activate Voting</span>
                            </label>
                        </div>
                        <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:24px">
                            <button type="button" id="resetSettingsForm" class="secondary">Reset</button>
                            <button type="submit">Save Settings</button>
                        </div>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Candidate Modal -->
    <div class="modal" id="candidateModal">
        <div class="card" role="dialog" aria-modal="true" aria-labelledby="candidateModalTitle">
            <h3 id="candidateModalTitle" style="margin:0 0 20px 0;color:var(--text);">Add New Candidate</h3>
            <form id="candidateForm">
                <div id="candidateModalBody">
                    <div class="form-group">
                        <label for="candidateName">Candidate Name</label>
                        <input type="text" id="candidateName" name="name" required placeholder="Enter full name">
                    </div>
                    <div class="form-group">
                        <label for="candidatePosition">Position</label>
                        <select id="candidatePosition" name="position" required>
                            <option value="">Select Position</option>
                            <option value="President">President</option>
                            <option value="Vice President">Vice President</option>
                            <option value="Secretary">Secretary</option>
                            <option value="Treasurer">Treasurer</option>
                            <option value="Auditor">Auditor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="candidateBio">Biography/Description</label>
                        <textarea id="candidateBio" name="bio" placeholder="Brief description about the candidate"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="candidatePhoto">Photo URL (optional)</label>
                        <input type="text" id="candidatePhoto" name="photo" placeholder="Enter image URL">
                    </div>
                </div>
                <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:24px">
                    <button type="button" id="candidateModalCancel" class="secondary">Cancel</button>
                    <button type="submit">Save Candidate</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Suspend Voter Modal -->
    <div class="modal" id="suspendModal">
        <div class="card" role="dialog" aria-modal="true">
            <h3 style="margin:0 0 20px 0;color:var(--text);">Suspend Voter Account</h3>
            <form id="suspendForm">
                <input type="hidden" id="suspendVoterId">
                <div class="form-group">
                    <label for="suspendReason">Reason for Suspension</label>
                    <textarea id="suspendReason" name="reason" required placeholder="Enter the reason for suspending this account..." rows="4"></textarea>
                </div>
                <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:24px">
                    <button type="button" id="suspendModalCancel" class="secondary">Cancel</button>
                    <button type="submit" class="danger">Suspend Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Voter Modal -->
    <div class="modal" id="deleteModal">
        <div class="card" role="dialog" aria-modal="true">
            <h3 style="margin:0 0 16px 0;color:var(--text);">Delete Voter Account</h3>
            <p style="color: var(--muted); margin-bottom: 24px; line-height: 1.6;">Are you sure you want to delete this voter account? This action cannot be undone and the user will no longer be able to log in.</p>
            <input type="hidden" id="deleteVoterId">
            <div style="display:flex;justify-content:flex-end;gap:12px">
                <button type="button" id="deleteModalCancel" class="secondary">Cancel</button>
                <button type="button" id="confirmDelete" class="danger">Delete Account</button>
            </div>
        </div>
    </div>

    <footer>Voting Assistance System © 2024</footer>

    <script>
        // DOM refs
        const views = document.querySelectorAll('.view');
        const navItems = document.querySelectorAll('.nav-item');
        const candidateModal = document.getElementById('candidateModal');
        const candidateForm = document.getElementById('candidateForm');
        const candidateModalCancel = document.getElementById('candidateModalCancel');
        const suspendModal = document.getElementById('suspendModal');
        const suspendForm = document.getElementById('suspendForm');
        const suspendModalCancel = document.getElementById('suspendModalCancel');
        const deleteModal = document.getElementById('deleteModal');
        const deleteModalCancel = document.getElementById('deleteModalCancel');
        const confirmDelete = document.getElementById('confirmDelete');

        let editingCandidateId = null;
        let currentVotingState = false; // Global state to track voting status

        // Navigation
        navItems.forEach(a=>{
            a.addEventListener('click', e=>{
                e.preventDefault();
                navItems.forEach(n=>n.classList.remove('active'));
                a.classList.add('active');
                const view = a.dataset.view;
                showView(view);
            });
        });

        function showView(name){
            views.forEach(v=>v.style.display = v.id === 'view-' + name ? '' : 'none');
            if (name === 'candidates') {
                loadCandidates();
                loadElectionSettings(); 
            } else if (name === 'voters') {
                loadVoters();
            } else if (name === 'results') {
                loadResults();
            }
            
            // Update voting controls based on current state whenever view changes
            updateVotingControls(currentVotingState);
        }

        // Reset all votes function
        function resetAllVotes() {
            if (confirm('DANGER ZONE! This will DELETE ALL VOTES permanently!\n\nAll users will be able to vote again.\nThis cannot be undone!\n\nClick OK to continue or Cancel to abort.')) {
                fetch('/voting_system/backend/reset_votes.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: 'admin123' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('All votes reset successfully! Users can now vote again.');
                        // Reload stats and voters
                        loadStats();
                        if (document.getElementById('view-voters').style.display !== 'none') {
                            loadVoters();
                        }
                    } else {
                        alert('Reset failed: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Network error: ' + error);
                });
            }
        }

        // Load stats for overview
        function loadStats() {
            // Load total voters
            fetch('/voting_system/backend/get_voters.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.voters) {
                        document.getElementById('totalVoters').textContent = data.voters.length;
                    }
                });

            // Load total candidates
            fetch('/voting_system/backend/get_candidates.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.candidates) {
                        document.getElementById('totalCandidates').textContent = data.candidates.length;
                    }
                });

            // Load total votes
            fetch('/voting_system/backend/get_votes_count.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('totalVotes').textContent = data.total_votes || 0;
                    }
                });
        }

        // Load election settings
        function loadElectionSettings() {
            fetch('/voting_system/backend/get_election_settings.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.settings) {
                        const settings = data.settings;
                        document.getElementById('electionTitle').value = settings.election_title || '';
                        document.getElementById('electionDescription').value = settings.election_description || '';
                        
                        // Format dates for datetime-local input
                        const formatDateForInput = (dateString) => {
                            if (!dateString) return '';
                            const date = new Date(dateString);
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            const hours = String(date.getHours()).padStart(2, '0');
                            const minutes = String(date.getMinutes()).padStart(2, '0');
                            return `${year}-${month}-${day}T${hours}:${minutes}`;
                        };
                        
                        document.getElementById('startDate').value = formatDateForInput(settings.start_date);
                        document.getElementById('endDate').value = formatDateForInput(settings.end_date);
                        
                        // Update global voting state and controls
                        currentVotingState = settings.is_active || false;
                        updateVotingControls(currentVotingState);
                        
                        // Update status display
                        updateElectionStatusDisplay(currentVotingState);
                    }
                })
                .catch(error => {
                    console.error('Error loading election settings:', error);
                });
        }

        // Update voting control buttons
        function updateVotingControls(isActive) {
            const startBtn = document.getElementById('startVotingBtn');
            const stopBtn = document.getElementById('stopVotingBtn');
            
            if (isActive) {
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
            } else {
                startBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
            }
        }

        // Update election status display
        function updateElectionStatusDisplay(isActive) {
            const statusElement = document.getElementById('electionStatus');
            if (isActive) {
                statusElement.innerHTML = 'Status: <span style="color:#10b981;font-weight:600">Voting ACTIVE</span>';
            } else {
                statusElement.innerHTML = 'Status: <span style="color:#ef4444;font-weight:600">Voting INACTIVE</span>';
            }
        }

        // Start voting - saves configuration AND starts voting
        document.getElementById('startVotingBtn').addEventListener('click', function() {
            const title = document.getElementById('electionTitle').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!title || !startDate || !endDate) {
                alert('Please fill in Election Title, Start Date, and End Date before starting voting.');
                return;
            }
            
            if (confirm('Start voting now? This will allow users to cast their votes.')) {
                updateVotingStatus(1);
            }
        });

        // Stop voting
        document.getElementById('stopVotingBtn').addEventListener('click', function() {
            if (confirm('Stop voting now? This will prevent users from casting new votes.')) {
                updateVotingStatus(0);
            }
        });

        // Reset all votes button
        document.getElementById('resetAllBtn').addEventListener('click', resetAllVotes);

        // Update voting status in database
        function updateVotingStatus(isActive, showAlert = true) {
            const settings = {
                election_title: document.getElementById('electionTitle').value,
                election_description: document.getElementById('electionDescription').value,
                start_date: document.getElementById('startDate').value.replace('T', ' ') + ':00',
                end_date: document.getElementById('endDate').value.replace('T', ' ') + ':00',
                is_active: isActive
            };
            
            fetch('/voting_system/backend/save_election_settings.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update global state
                    currentVotingState = isActive;
                    
                    // Update UI controls
                    updateVotingControls(isActive);
                    updateElectionStatusDisplay(isActive);
                    
                    if (isActive) {
                        if (showAlert) alert('Voting started successfully!');
                    } else {
                        if (showAlert) alert('Voting stopped successfully!');
                    }
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Network error: ' + error);
            });
        }

        // Export results
        document.getElementById('exportResultsBtn').addEventListener('click', function() {
            alert('Exporting results... This would generate a CSV/PDF file in a real implementation.');
        });

        // Candidate management functions
        function loadCandidates() {
            fetch('/voting_system/backend/get_candidates.php')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('candidatesTableBody');
                    if (data.success && data.candidates) {
                        tbody.innerHTML = '';
                        data.candidates.forEach(candidate => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td><strong>${escapeHtml(candidate.name)}</strong></td>
                                <td>${escapeHtml(candidate.position)}</td>
                                <td>${candidate.is_active ? '<span class="badge success">Active</span>' : '<span class="badge danger">Inactive</span>'}</td>
                                <td class="actions">
                                    <button class="secondary" onclick="startEditCandidate(${candidate.id}, '${escapeHtml(candidate.name)}', '${escapeHtml(candidate.position)}', '${escapeHtml(candidate.bio || '')}', '${escapeHtml(candidate.photo || '')}')">Edit</button>
                                    <button class="danger" onclick="deleteCandidate(${candidate.id})">Delete</button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">No candidates found</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading candidates:', error);
                    document.getElementById('candidatesTableBody').innerHTML = 
                        '<tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">Error loading candidates</td></tr>';
                });
        }

        function startEditCandidate(id, name, position, bio, photo) {
            editingCandidateId = id;
            const tbody = document.getElementById('candidatesTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                if (row.cells[3]?.querySelector(`button[onclick*="startEditCandidate(${id},"]`)) {
                    row.classList.add('editing-row');
                    row.innerHTML = `
                        <td><input type="text" class="edit-input" value="${name}" id="editName_${id}"></td>
                        <td>
                            <select class="edit-select" id="editPosition_${id}">
                                <option value="President" ${position === 'President' ? 'selected' : ''}>President</option>
                                <option value="Vice President" ${position === 'Vice President' ? 'selected' : ''}>Vice President</option>
                                <option value="Secretary" ${position === 'Secretary' ? 'selected' : ''}>Secretary</option>
                                <option value="Treasurer" ${position === 'Treasurer' ? 'selected' : ''}>Treasurer</option>
                                <option value="Auditor" ${position === 'Auditor' ? 'selected' : ''}>Auditor</option>
                            </select>
                        </td>
                        <td><span class="badge success">Editing</span></td>
                        <td class="actions">
                            <button class="secondary" onclick="saveCandidate(${id})">Save</button>
                            <button class="danger" onclick="cancelEditCandidate(${id})">Cancel</button>
                        </td>
                    `;
                    break;
                }
            }
        }

        function saveCandidate(id) {
            const name = document.getElementById(`editName_${id}`).value;
            const position = document.getElementById(`editPosition_${id}`).value;
            const bio = ''; // You can add bio editing if needed
            const photo = ''; // You can add photo editing if needed

            if (!name || !position) {
                alert('Please fill in all fields');
                return;
            }

            fetch('/voting_system/backend/edit_candidate.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id, name, position, bio, photo })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showCandidateMessage('Candidate updated successfully!', 'success');
                    loadCandidates();
                } else {
                    showCandidateMessage('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showCandidateMessage('Network error: ' + error, 'error');
            });
        }

        function cancelEditCandidate(id) {
            loadCandidates();
        }

        function addCandidate(candidateData) {
            fetch('/voting_system/backend/add_candidate.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(candidateData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showCandidateMessage('Candidate added successfully!', 'success');
                    candidateModal.classList.remove('open');
                    candidateForm.reset();
                    loadCandidates();
                    loadStats();
                } else {
                    showCandidateMessage('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showCandidateMessage('Network error: ' + error, 'error');
            });
        }

        function deleteCandidate(candidateId) {
            if (confirm('Are you sure you want to delete this candidate?')) {
                fetch('/voting_system/backend/delete_candidate.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: candidateId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showCandidateMessage('Candidate deleted successfully!', 'success');
                        loadCandidates();
                        loadStats();
                    } else {
                        showCandidateMessage('Error: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showCandidateMessage('Network error: ' + error, 'error');
                });
            }
        }

        function showCandidateMessage(text, type) {
            const messageDiv = document.getElementById('candidateMessage');
            messageDiv.innerHTML = text;
            messageDiv.className = `message ${type}`;
            
            setTimeout(() => {
                messageDiv.innerHTML = '';
                messageDiv.className = '';
            }, 5000);
        }

        // Voter management functions
        function loadVoters() {
            fetch('/voting_system/backend/get_voters.php')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('votersTableBody');
                    if (data.success && data.voters) {
                        tbody.innerHTML = '';
                        data.voters.forEach(voter => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td><strong>${escapeHtml(voter.name)}</strong></td>
                                <td>${escapeHtml(voter.email)}</td>
                                <td>${voter.has_voted ? '<span class="badge success">Voted</span>' : '<span class="badge muted">Not Voted</span>'}</td>
                                <td>
                                    ${voter.status === 'active' ? '<span class="badge success">Active</span>' : 
                                      voter.status === 'suspended' ? '<span class="badge danger">Suspended</span>' : 
                                      '<span class="badge success">Active</span>'}
                                </td>
                                <td class="actions">
                                    ${voter.status === 'suspended' ? 
                                        `<button class="success" onclick="unsuspendVoter(${voter.id})">Unsuspend</button>` : 
                                        `<button class="secondary" onclick="suspendVoter(${voter.id}, '${escapeHtml(voter.name)}')">Suspend</button>`
                                    }
                                    <button class="danger" onclick="deleteVoter(${voter.id}, '${escapeHtml(voter.name)}')">Delete</button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:32px;color:var(--muted)">No voters found</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading voters:', error);
                    document.getElementById('votersTableBody').innerHTML = 
                        '<tr><td colspan="5" style="text-align:center;padding:32px;color:var(--muted)">Error loading voters</td></tr>';
                });
        }

        function suspendVoter(voterId, voterName) {
            document.getElementById('suspendVoterId').value = voterId;
            document.getElementById('suspendModal').classList.add('open');
            document.body.classList.add('modal-open');
        }

        function unsuspendVoter(voterId) {
            if (confirm('Are you sure you want to unsuspend this voter?')) {
                fetch('/voting_system/backend/unsuspend_voter.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: voterId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Voter unsuspended successfully!');
                        loadVoters();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Network error: ' + error);
                });
            }
        }

        function deleteVoter(voterId, voterName) {
            document.getElementById('deleteVoterId').value = voterId;
            document.getElementById('deleteModal').classList.add('open');
            document.body.classList.add('modal-open');
        }

        // Modal controls
        function openCandidateModal() {
            candidateModal.classList.add('open');
            document.body.classList.add('modal-open');
        }

        function closeCandidateModal() {
            candidateModal.classList.remove('open');
            candidateForm.reset();
            document.body.classList.remove('modal-open');
        }

        function closeSuspendModal() {
            suspendModal.classList.remove('open');
            suspendForm.reset();
            document.body.classList.remove('modal-open');
        }

        function closeDeleteModal() {
            deleteModal.classList.remove('open');
            document.body.classList.remove('modal-open');
        }

        // Event listeners
        candidateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('candidateName').value,
                position: document.getElementById('candidatePosition').value,
                bio: document.getElementById('candidateBio').value,
                photo: document.getElementById('candidatePhoto').value || 'default_photo.jpg'
            };

            addCandidate(formData);
        });

        suspendForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const voterId = document.getElementById('suspendVoterId').value;
            const reason = document.getElementById('suspendReason').value;

            fetch('/voting_system/backend/suspend_voter.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: voterId, reason: reason })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Voter suspended successfully!');
                    closeSuspendModal();
                    loadVoters();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Network error: ' + error);
            });
        });

        confirmDelete.addEventListener('click', function() {
            const voterId = document.getElementById('deleteVoterId').value;

            fetch('/voting_system/backend/delete_voter.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: voterId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Voter deleted successfully!');
                    closeDeleteModal();
                    loadVoters();
                    loadStats();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Network error: ' + error);
            });
        });

        candidateModalCancel.addEventListener('click', closeCandidateModal);
        candidateModal.addEventListener('click', function(e) {
            if (e.target === candidateModal) closeCandidateModal();
        });

        suspendModalCancel.addEventListener('click', closeSuspendModal);
        suspendModal.addEventListener('click', function(e) {
            if (e.target === suspendModal) closeSuspendModal();
        });

        deleteModalCancel.addEventListener('click', closeDeleteModal);
        deleteModal.addEventListener('click', function(e) {
            if (e.target === deleteModal) closeDeleteModal();
        });

        // Add candidate buttons
        document.getElementById('addCandidateBtn').addEventListener('click', openCandidateModal);
        document.getElementById('addCandidateBtn2').addEventListener('click', openCandidateModal);

        // Helper function
        function escapeHtml(s) { 
            return (s+'').replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); 
        }

        // Initialize - ensure voting is stopped on page load
        showView('overview');
        loadCandidates();
        loadStats();
        loadElectionSettings();
    </script>
</body>
</html>