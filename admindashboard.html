<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>VotingEase — Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="./asset/style/admindb.css">
    <style>
        /* Smooth Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        header {
            animation: fadeInDown 0.5s ease-out;
        }

        nav {
            animation: fadeInLeft 0.6s ease-out;
        }

        .nav-item {
            transition: all 0.3s ease;
        }

        .nav-item:hover {
            transform: translateX(5px);
        }

        .card {
            animation: scaleIn 0.5s ease-out;
            animation-fill-mode: both;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .stat:nth-child(1) { animation-delay: 0.1s; }
        .stat:nth-child(2) { animation-delay: 0.2s; }
        .stat:nth-child(3) { animation-delay: 0.3s; }

        button {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        table tr {
            animation: fadeIn 0.4s ease-out;
            animation-fill-mode: both;
            transition: background-color 0.2s ease;
        }

        table tbody tr:nth-child(1) { animation-delay: 0.05s; }
        table tbody tr:nth-child(2) { animation-delay: 0.1s; }
        table tbody tr:nth-child(3) { animation-delay: 0.15s; }
        table tbody tr:nth-child(4) { animation-delay: 0.2s; }
        table tbody tr:nth-child(5) { animation-delay: 0.25s; }

        .modal {
            transition: opacity 0.3s ease, backdrop-filter 0.3s ease;
        }

        .modal.open {
            animation: fadeIn 0.3s ease-out;
        }

        .modal.open .card {
            animation: scaleIn 0.4s ease-out;
        }

        .view {
            animation: fadeInUp 0.5s ease-out;
        }

        input, select, textarea {
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .badge {
            animation: fadeIn 0.5s ease-out;
        }

        /* Smooth scrolling */
        * {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>
    <header>
        <h1>VoteEase Admin Dashboard</h1>
        <div class="controls">
         
        </div>
    </header>

    <div class="layout">
        <nav aria-label="Main navigation">
            <a href="#" class="nav-item active" data-view="overview">
                Overview
            </a>
            <a href="#" class="nav-item" data-view="candidates">
                Election
            </a>
            <a href="#" class="nav-item" data-view="voters">
                Voters
            </a>
            <a href="#" class="nav-item" data-view="results">
                Results
            </a>
            <a href="#" class="nav-item" data-view="archived">
                Archived
            </a>
            <hr style="border:none;height:1px;background:var(--border);margin:16px 20px;">
            <a href="#" class="nav-item" id="logoutBtn">
                Logout
            </a>
        </nav>

        <main>
            <!-- Overview -->
            <section id="view-overview" class="view">
                <div class="row">
                    <div class="card stat">
                        <h3>Total Voters</h3>
                        <p id="totalVoters">0</p>
                    </div>
                    <div class="card stat">
                        <h3>Total Candidates</h3>
                        <p id="totalCandidates">0</p>
                    </div>
                    <div class="card stat">
                        <h3>Total Votes Cast</h3>
                        <p id="totalVotes">0</p>
                    </div>
                </div>

                <!-- Recent Users Section -->
                <div class="card" style="margin-top:24px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                        <h3 style="margin:0;color:var(--text);">Recent Registered Users</h3>
                        <button id="refreshRecentUsers" class="secondary">Refresh</button>
                    </div>
                    <div id="recentUsersList">
                        <div style="text-align:center;padding:32px;color:var(--muted)">Loading recent users...</div>
                    </div>
                </div>
            </section>

            <!-- Candidates -->
            <section id="view-candidates" class="view" style="display:none">
                <!-- Election Configuration -->
                <div class="card" style="margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                        <h3 style="margin:0;color:var(--text);">Election Controls</h3>
                        <div class="election-controls">
                            <button id="startVotingBtn" class="success">Start Voting</button>
                            <button id="stopVotingBtn" class="danger" style="display:none;">Stop Voting</button>
                            <button id="resetAllBtn" class="danger" title="Reset all votes">Reset All Votes</button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label for="electionTitle">Election Title</label>
                            <input type="text" id="electionTitle" name="election_title" required placeholder="Enter election title">
                        </div>
                        <div class="form-group">
                            <label for="electionDescription">Description</label>
                            <input type="text" id="electionDescription" name="election_description" placeholder="Brief description">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 16px;">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="datetime-local" id="startDate" name="start_date" required>
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <input type="datetime-local" id="endDate" name="end_date" required>
                        </div>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:20px">
                        <div class="muted" id="electionStatus">Status: Not configured</div>
                        <button type="button" id="resetSettings" class="secondary">Reset Form</button>
                    </div>
                </div>

                <!-- Candidate Management -->
                <div class="card" style="margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <h3 style="margin:0;color:var(--text);">Candidate Management</h3>
                        <div>
                            <button id="addCandidateBtn">Add New Candidate</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div id="candidateMessage"></div>
                    <table id="candidatesTable" aria-describedby="candidates">
                        <thead>
                            <tr><th>Candidate</th><th>Position</th><th>Status</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="candidatesTableBody">
                            <tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">Loading candidates...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Voters -->
            <section id="view-voters" class="view" style="display:none">
                <div class="card" style="margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <h3 style="margin:0;color:var(--text);">Registered Voters</h3>
                        <div>
                            <input type="text" id="voterSearchInput" placeholder="Search voters..." style="padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);width:300px">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div id="voterMessage"></div>
                    <table id="votersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Has Voted</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="votersTableBody">
                            <tr><td colspan="5" style="text-align:center;padding:32px;color:var(--muted)">Loading voters...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Results -->
            <section id="view-results" class="view" style="display:none">
                <div class="card" style="margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <h3 style="margin:0;color:var(--text);">Live Results</h3>
                        <div>
                            <button id="refreshResultsBtn" class="secondary">Refresh Results</button>
                            <button id="exportResultsBtn" class="secondary">Export Results</button>
                        </div>
                    </div>
                </div>

                <div class="results-container">
                    <div class="card">
                        <h3 style="margin:0 0 20px 0;color:var(--text);">Vote Statistics</h3>
                        <div id="resultsList"></div>
                    </div>
                    
                    <div class="chart-container">
                        <h3 style="margin:0 0 20px 0;color:var(--text);">Live Vote Chart</h3>
                        <div id="resultsChart" class="chart-placeholder">
                            Loading live results...
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-archived" class="view" style="display:none">
                <div class="card" style="margin-bottom:20px">
                    <h3 style="margin:0;color:var(--text);">Archived Records</h3>
                </div>

                <div class="card" style="margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                        <h3 style="margin:0;color:var(--text);">Archived Candidates</h3>
                        <input type="text" id="archivedCandidateSearch" placeholder="Search archived candidates..." style="padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);width:300px">
                    </div>
                    <table id="archivedCandidatesTable">
                        <thead>
                            <tr><th>Candidate</th><th>Position</th><th>Archived Date</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="archivedCandidatesTableBody">
                            <tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">Loading archived candidates...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                        <h3 style="margin:0;color:var(--text);">Archived Voters</h3>
                        <input type="text" id="archivedVoterSearch" placeholder="Search archived voters..." style="padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);width:300px">
                    </div>
                    <table id="archivedVotersTable">
                        <thead>
                            <tr><th>Name</th><th>Email</th><th>Archived Date</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="archivedVotersTableBody">
                            <tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">Loading archived voters...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Candidate Modal -->
    <div class="modal" id="candidateModal">
        <div class="card" role="dialog" aria-modal="true" aria-labelledby="candidateModalTitle">
            <h3 id="candidateModalTitle" style="margin:0 0 20px 0;color:var(--text);">Add New Candidate</h3>
            <form id="candidateForm">
                <div id="candidateModalBody">
                    <div class="form-group">
                        <label for="candidateName">Candidate Name</label>
                        <input type="text" id="candidateName" name="name" required placeholder="Enter full name">
                    </div>
                    <div class="form-group">
                        <label for="candidatePosition">Position</label>
                        <select id="candidatePosition" name="position" required>
                            <option value="">Select Position</option>
                            <option value="President">President</option>
                            <option value="Vice President">Vice President</option>
                            <option value="Secretary">Secretary</option>
                            <option value="Treasurer">Treasurer</option>
                            <option value="Auditor">Auditor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="candidateBio">Biography/Description</label>
                        <textarea id="candidateBio" name="bio" placeholder="Brief description about the candidate"></textarea>
                    </div>
                
                </div>
                <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:24px">
                    <button type="button" id="candidateModalCancel" class="secondary">Cancel</button>
                    <button type="submit">Save Candidate</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Suspend Voter Modal -->
    <div class="modal" id="suspendModal">
        <div class="card" role="dialog" aria-modal="true">
            <h3 style="margin:0 0 20px 0;color:var(--text);">Suspend Voter Account</h3>
            <form id="suspendForm">
                <input type="hidden" id="suspendVoterId">
                <div class="form-group">
                    <label for="suspendReason">Reason for Suspension</label>
                    <textarea id="suspendReason" name="reason" required placeholder="Enter the reason for suspending this account..." rows="4"></textarea>
                </div>
                <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:24px">
                    <button type="button" id="suspendModalCancel" class="secondary">Cancel</button>
                    <button type="submit" class="danger">Suspend Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Voter Modal -->
    <div class="modal" id="deleteModal">
        <div class="card" role="dialog" aria-modal="true">
            <h3 style="margin:0 0 16px 0;color:var(--text);">Delete Voter Account</h3>
            <p style="color: var(--muted); margin-bottom: 24px; line-height: 1.6;">Are you sure you want to delete this voter account? This action cannot be undone and the user will no longer be able to log in.</p>
            <input type="hidden" id="deleteVoterId">
            <div style="display:flex;justify-content:flex-end;gap:12px">
                <button type="button" id="deleteModalCancel" class="secondary">Cancel</button>
                <button type="button" id="confirmDelete" class="danger">Delete Account</button>
            </div>
        </div>
    </div>

    <footer>VoteEase © 2025</footer>

    <script>
       
        const views = document.querySelectorAll('.view');
        const navItems = document.querySelectorAll('.nav-item');
        const candidateModal = document.getElementById('candidateModal');
        const candidateForm = document.getElementById('candidateForm');
        const candidateModalCancel = document.getElementById('candidateModalCancel');
        const suspendModal = document.getElementById('suspendModal');
        const suspendForm = document.getElementById('suspendForm');
        const suspendModalCancel = document.getElementById('suspendModalCancel');
        const deleteModal = document.getElementById('deleteModal');
        const deleteModalCancel = document.getElementById('deleteModalCancel');
        const confirmDelete = document.getElementById('confirmDelete');
        const logoutBtn = document.getElementById('logoutBtn');
        const exportResultsBtn = document.getElementById('exportResultsBtn');
        const addCandidateBtn = document.getElementById('addCandidateBtn');
        const resetSettingsBtn = document.getElementById('resetSettings');

        let editingCandidateId = null;
        let currentVotingState = false;
        let resultsInterval = null;

     
        navItems.forEach(a => {
            a.addEventListener('click', e => {
                e.preventDefault();
                navItems.forEach(n => n.classList.remove('active'));
                a.classList.add('active');
                const view = a.dataset.view;
                showView(view);
            });
        });

        function showView(name) {
            views.forEach(v => v.style.display = v.id === 'view-' + name ? '' : 'none');
            if (name === 'candidates') {
                loadCandidates();
                loadElectionSettings(); 
            } else if (name === 'voters') {
                loadVoters();
            } else if (name === 'results') {
                loadResults();
                startResultsAutoRefresh();
            } else if (name === 'archived') {
                loadArchivedCandidates();
                loadArchivedVoters();
            } else if (name === 'overview') {
                loadRecentUsers();
            } else {
                stopResultsAutoRefresh();
            }
            updateVotingControls(currentVotingState);
        }

        //  auto-refresh
        function startResultsAutoRefresh() {
            resultsInterval = setInterval(loadResults, 5000);
        }

        function stopResultsAutoRefresh() {
            if (resultsInterval) {
                clearInterval(resultsInterval);
                resultsInterval = null;
            }
        }

        // reset all votes function
        function resetAllVotes() {
            Swal.fire({
                title: 'DANGER ZONE!',
                html: 'This will DELETE ALL VOTES permanently!<br><br>All users will be able to vote again.<br>This cannot be undone!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#9aa3ad',
                confirmButtonText: 'Yes, Reset All Votes',
                cancelButtonText: 'Cancel',
                background: '#1a1c20',
                color: '#eaeaea'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('./backend/reset_votes.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ password: 'admin123' })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: 'All votes reset successfully! Users can now vote again.',
                                showConfirmButton: false,
                                timer: 2000,
                                background: '#1a1c20',
                                color: '#eaeaea'
                            });
                            loadStats();
                            if (document.getElementById('view-voters').style.display !== 'none') {
                                loadVoters();
                            }
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Reset Failed',
                                text: data.message,
                                confirmButtonColor: '#4e9eff',
                                background: '#1a1c20',
                                color: '#eaeaea'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Network Error',
                            text: error.toString(),
                            confirmButtonColor: '#4e9eff',
                            background: '#1a1c20',
                            color: '#eaeaea'
                        });
                    });
                }
            });
        }


        function loadStats() {
            // load total voters
            fetch('./backend/get_voters.php?t=' + new Date().getTime())
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.voters) {
                        document.getElementById('totalVoters').textContent = data.voters.length;
                    }
                });

            // load total candidates
            fetch('./backend/get_candidates.php?t=' + new Date().getTime())
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.candidates) {
                        document.getElementById('totalCandidates').textContent = data.candidates.length;
                    }
                });

            // load total votes
            fetch('./backend/get_votes_count.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('totalVotes').textContent = data.total_votes || 0;
                    }
                });
        }

        // load recent users
        function loadRecentUsers() {
            fetch('./backend/get_voters.php?t=' + new Date().getTime())
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('recentUsersList');
                    if (data.success && data.voters && data.voters.length > 0) {
                        
                        const recentVoters = data.voters
                            .sort((a, b) => b.id - a.id)
                            .slice(0, 5);
                        
                        let html = '<div class="recent-users-list">';
                        
                        recentVoters.forEach(voter => {
                            html += `
                                <div class="recent-user-item">
                                    <div class="user-avatar">${getInitials(voter.name)}</div>
                                    <div class="user-info">
                                        <div class="user-name">${escapeHtml(voter.name)}</div>
                                        <div class="user-email">${escapeHtml(voter.email)}</div>
                                        <div class="user-status">
                                            ${parseInt(voter.has_voted) === 1 ? '<span class="badge success">Voted</span>' : '<span class="badge muted">Not Voted</span>'}
                                            ${voter.status === 'suspended' ? '<span class="badge danger">Suspended</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<div style="text-align:center;padding:32px;color:var(--muted)">No users found</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading recent users:', error);
                    document.getElementById('recentUsersList').innerHTML = 
                        '<div style="text-align:center;padding:32px;color:var(--muted)">Error loading recent users</div>';
                });
        }

        
        function getInitials(name) {
            return name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2);
        }

       
        function loadElectionSettings() {
            fetch('./backend/get_election_settings.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.settings) {
                        const settings = data.settings;
                        document.getElementById('electionTitle').value = settings.election_title || '';
                        document.getElementById('electionDescription').value = settings.election_description || '';
                        
                        const formatDateForInput = (dateString) => {
                            if (!dateString) return '';
                            const date = new Date(dateString);
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            const hours = String(date.getHours()).padStart(2, '0');
                            const minutes = String(date.getMinutes()).padStart(2, '0');
                            return `${year}-${month}-${day}T${hours}:${minutes}`;
                        };
                        
                        document.getElementById('startDate').value = formatDateForInput(settings.start_date);
                        document.getElementById('endDate').value = formatDateForInput(settings.end_date);
                        
                        currentVotingState = settings.is_active || false;
                        updateVotingControls(currentVotingState);
                        updateElectionStatusDisplay(currentVotingState);
                    }
                })
                .catch(error => {
                    console.error('Error loading election settings:', error);
                });
        }

        // update voting control buttons
        function updateVotingControls(isActive) {
            const startBtn = document.getElementById('startVotingBtn');
            const stopBtn = document.getElementById('stopVotingBtn');
            
            if (isActive) {
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
            } else {
                startBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
            }
        }

        // update election status display
        function updateElectionStatusDisplay(isActive) {
            const statusElement = document.getElementById('electionStatus');
            if (isActive) {
                statusElement.innerHTML = 'Status: <span style="color:#10b981;font-weight:600">Voting ACTIVE</span>';
            } else {
                statusElement.innerHTML = 'Status: <span style="color:#ef4444;font-weight:600">Voting INACTIVE</span>';
            }
        }

        // start voting
        document.getElementById('startVotingBtn').addEventListener('click', function() {
            const title = document.getElementById('electionTitle').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!title || !startDate || !endDate) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Missing Information',
                    text: 'Please fill in Election Title, Start Date, and End Date before starting voting.',
                    confirmButtonColor: '#4e9eff',
                    background: '#1a1c20',
                    color: '#eaeaea'
                });
                return;
            }
            
            Swal.fire({
                title: 'Start Voting',
                text: 'Start voting now? This will allow users to cast their votes.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#36c97e',
                cancelButtonColor: '#9aa3ad',
                confirmButtonText: 'Yes, Start Voting',
                cancelButtonText: 'Cancel',
                background: '#1a1c20',
                color: '#eaeaea'
            }).then((result) => {
                if (result.isConfirmed) {
                    updateVotingStatus(1);
                }
            });
        });

        // stop voting
        document.getElementById('stopVotingBtn').addEventListener('click', function() {
            Swal.fire({
                title: 'Stop Voting',
                text: 'Stop voting now? This will prevent users from casting new votes.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#9aa3ad',
                confirmButtonText: 'Yes, Stop Voting',
                cancelButtonText: 'Cancel',
                background: '#1a1c20',
                color: '#eaeaea'
            }).then((result) => {
                if (result.isConfirmed) {
                    updateVotingStatus(0);
                }
            });
        });

      
        document.getElementById('resetAllBtn').addEventListener('click', resetAllVotes);

        // Reset form button 
        resetSettingsBtn.addEventListener('click', function() {
            Swal.fire({
                title: 'Reset Election Form',
                text: 'Are you sure you want to reset the election form? All fields will be cleared.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#9aa3ad',
                confirmButtonText: 'Yes, Reset',
                cancelButtonText: 'Cancel',
                background: '#1a1c20',
                color: '#eaeaea'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('electionTitle').value = '';
                    document.getElementById('electionDescription').value = '';
                    document.getElementById('startDate').value = '';
                    document.getElementById('endDate').value = '';
                    
                    currentVotingState = false;
                    updateVotingControls(false);
                    updateElectionStatusDisplay(false);
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: 'Election form has been reset successfully!',
                        showConfirmButton: false,
                        timer: 2000,
                        background: '#1a1c20',
                        color: '#eaeaea'
                    });
                }
            });
        });
     
        function updateVotingStatus(isActive, showAlert = true) {
            const settings = {
                election_title: document.getElementById('electionTitle').value,
                election_description: document.getElementById('electionDescription').value,
                start_date: document.getElementById('startDate').value.replace('T', ' ') + ':00',
                end_date: document.getElementById('endDate').value.replace('T', ' ') + ':00',
                is_active: isActive
            };
            
            fetch('./backend/save_election_settings.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentVotingState = isActive;
                    updateVotingControls(isActive);
                    updateElectionStatusDisplay(isActive);
                    
                    if (showAlert) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Success',
                            text: isActive ? 'Voting started successfully!' : 'Voting stopped successfully!',
                            showConfirmButton: false,
                            timer: 2000,
                            background: '#1a1c20',
                            color: '#eaeaea'
                        });
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message,
                        confirmButtonColor: '#4e9eff',
                        background: '#1a1c20',
                        color: '#eaeaea'
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Network Error',
                    text: error.toString(),
                    confirmButtonColor: '#4e9eff',
                    background: '#1a1c20',
                    color: '#eaeaea'
                });
            });
        }

        
        function loadResults() {
            fetch('./backend/get_live_results.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.results) {
                        displayResults(data.results);
                        updateResultsChart(data.results);
                    } else {
                        document.getElementById('resultsList').innerHTML = 
                            '<div style="text-align:center;padding:32px;color:var(--muted)">No results available yet</div>';
                        document.getElementById('resultsChart').innerHTML = 
                            '<div class="chart-placeholder">No data available for chart</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading results:', error);
                    document.getElementById('resultsList').innerHTML = 
                        '<div style="text-align:center;padding:32px;color:var(--muted)">Error loading results</div>';
                    document.getElementById('resultsChart').innerHTML = 
                        '<div class="chart-placeholder">Error loading chart data</div>';
                });
        }

 
        function displayResults(results) {
            const resultsList = document.getElementById('resultsList');
            
            const resultsByPosition = {};
            results.forEach(candidate => {
                if (!resultsByPosition[candidate.position]) {
                    resultsByPosition[candidate.position] = [];
                }
                resultsByPosition[candidate.position].push(candidate);
            });
            
            Object.keys(resultsByPosition).forEach(position => {
                resultsByPosition[position].sort((a, b) => b.vote_count - a.vote_count);
                if (resultsByPosition[position].length > 0 && resultsByPosition[position][0].vote_count > 0) {
                    resultsByPosition[position][0].isLeading = true;
                }
            });
            
            const positionOrder = ['President', 'Vice President', 'Secretary', 'Treasurer', 'Auditor'];
            const sortedPositions = Object.keys(resultsByPosition).sort((a, b) => {
                const indexA = positionOrder.indexOf(a);
                const indexB = positionOrder.indexOf(b);
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            
            let html = '';
            
            sortedPositions.forEach(position => {
                const positionResults = resultsByPosition[position];
                const totalVotes = positionResults.reduce((sum, candidate) => sum + candidate.vote_count, 0);
                
                html += `
                    <div class="position-section">
                        <div class="position-header">${escapeHtml(position)}</div>
                `;
                
                positionResults.forEach(candidate => {
                    const percentage = totalVotes > 0 ? ((candidate.vote_count / totalVotes) * 100).toFixed(1) : 0;
                    
                    html += `
                        <div class="result-item ${candidate.isLeading ? 'leading' : ''}">
                            <div class="candidate-name">
                                ${escapeHtml(candidate.name)}
                                ${candidate.isLeading ? '<span class="leading-badge">LEADING</span>' : ''}
                            </div>
                            <div class="vote-progress">
                                <div class="vote-bar" style="width: ${percentage}%; background: ${getPositionColor(position)}"></div>
                            </div>
                            <div class="vote-count">
                                <span>${candidate.vote_count} votes</span>
                                <span>${percentage}%</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            resultsList.innerHTML = html || '<div style="text-align:center;padding:32px;color:var(--muted)">No votes cast yet</div>';
        }

        
        function updateResultsChart(results) {
            const chartContainer = document.getElementById('resultsChart');
            
            const resultsByPosition = {};
            results.forEach(candidate => {
                if (!resultsByPosition[candidate.position]) {
                    resultsByPosition[candidate.position] = [];
                }
                resultsByPosition[candidate.position].push(candidate);
            });
            
            Object.keys(resultsByPosition).forEach(position => {
                resultsByPosition[position].sort((a, b) => b.vote_count - a.vote_count);
                if (resultsByPosition[position].length > 0 && resultsByPosition[position][0].vote_count > 0) {
                    resultsByPosition[position][0].isLeading = true;
                }
            });
            
            const positionOrder = ['President', 'Vice President', 'Secretary', 'Treasurer', 'Auditor'];
            const sortedPositions = Object.keys(resultsByPosition).sort((a, b) => {
                const indexA = positionOrder.indexOf(a);
                const indexB = positionOrder.indexOf(b);
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            
            let html = '';
            
            sortedPositions.forEach(position => {
                const positionResults = resultsByPosition[position];
                const totalVotes = positionResults.reduce((sum, candidate) => sum + candidate.vote_count, 0);
                
                html += `
                    <div class="chart-section">
                        <div class="chart-section-header">
                            <span>${escapeHtml(position)}</span>
                        </div>
                `;
                
                positionResults.forEach(candidate => {
                    const percentage = totalVotes > 0 ? ((candidate.vote_count / totalVotes) * 100).toFixed(1) : 0;
                    
                    html += `
                        <div class="chart-candidate ${candidate.isLeading ? 'leading' : ''}">
                            <div class="chart-candidate-name">${escapeHtml(candidate.name)}</div>
                            <div class="chart-bar-container">
                                <div class="chart-bar" style="width: ${percentage}%; background: ${getPositionColor(position)}">
                                    <span class="chart-bar-percentage">${percentage}%</span>
                                </div>
                            </div>
                            <div class="chart-votes">${candidate.vote_count} votes</div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            chartContainer.innerHTML = html || '<div class="chart-placeholder">No data available</div>';
        }

      
        function getPositionColor(position) {
            const colors = {
                'President': '#3b82f6',
                'Vice President': '#10b981',
                'Secretary': '#f59e0b',
                'Treasurer': '#ef4444',
                'Auditor': '#8b5cf6'
            };
            return colors[position] || '#6b7280';
        }

        exportResultsBtn.addEventListener('click', function() {
            fetch('./backend/get_live_results.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.results) {
                        exportToCSV(data.results);
                    } else {
                        Swal.fire({
                            icon: 'info',
                            title: 'No Results',
                            text: 'No results available to export.',
                            confirmButtonColor: '#4e9eff',
                            background: '#1a1c20',
                            color: '#eaeaea'
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Export Error',
                        text: 'Error fetching results for export: ' + error,
                        confirmButtonColor: '#4e9eff',
                        background: '#1a1c20',
                        color: '#eaeaea'
                    });
                });
        });

        function exportToCSV(results) {
            const resultsByPosition = {};
            results.forEach(candidate => {
                if (!resultsByPosition[candidate.position]) {
                    resultsByPosition[candidate.position] = [];
                }
                resultsByPosition[candidate.position].push(candidate);
            });

            let csvContent = 'Election Results\n\n';
            
            Object.keys(resultsByPosition).sort().forEach(position => {
                const positionResults = resultsByPosition[position];
                const totalVotes = positionResults.reduce((sum, candidate) => sum + candidate.vote_count, 0);
                
                positionResults.sort((a, b) => b.vote_count - a.vote_count);
                
                csvContent += `${position}\n`;
                csvContent += 'Candidate,Votes,Percentage,Status\n';
                
                positionResults.forEach((candidate, index) => {
                    const percentage = totalVotes > 0 ? ((candidate.vote_count / totalVotes) * 100).toFixed(2) : '0.00';
                    const status = index === 0 && candidate.vote_count > 0 ? 'Leading' : '';
                    
                    csvContent += `"${candidate.name}",${candidate.vote_count},${percentage}%,${status}\n`;
                });
                
                csvContent += '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `election-results-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            Swal.fire({
                icon: 'success',
                title: 'Export Successful',
                text: 'Results exported successfully!',
                confirmButtonColor: '#36c97e',
                background: '#1a1c20',
                color: '#eaeaea'
            });
        }

   
        document.getElementById('refreshResultsBtn').addEventListener('click', function() {
            loadResults();
        });

       
        document.getElementById('refreshRecentUsers').addEventListener('click', function() {
            loadRecentUsers();
            loadStats();
        });

        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            Swal.fire({
                title: 'Logout Confirmation',
                text: 'Are you sure you want to logout?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#4e9eff',
                cancelButtonColor: '#9aa3ad',
                confirmButtonText: 'Yes, Logout',
                cancelButtonText: 'Cancel',
                background: '#1a1c20',
                color: '#eaeaea'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('./backend/logout.php', {
                        method: 'POST'
                    })
                    .then(response => {
                        window.location.href = 'index.html';
                    })
                    .catch(error => {
                        window.location.href = 'index.html';
                    });
                }
            });
        });

        
        function loadCandidates() {
            fetch('./backend/get_candidates.php?t=' + new Date().getTime())
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('candidatesTableBody');
                    if (data.success && data.candidates) {
                        tbody.innerHTML = '';
                        data.candidates.forEach(candidate => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td><strong>${escapeHtml(candidate.name)}</strong></td>
                                <td>${escapeHtml(candidate.position)}</td>
                                <td>${candidate.is_active ? '<span class="badge success">Active</span>' : '<span class="badge danger">Inactive</span>'}</td>
                                <td class="actions">
                                    <button class="secondary" onclick="startEditCandidate(${candidate.id}, '${escapeHtml(candidate.name)}', '${escapeHtml(candidate.position)}', '${escapeHtml(candidate.bio || '')}', '${escapeHtml(candidate.photo || '')}')">Edit</button>
                                    <button class="danger" onclick="deleteCandidate(${candidate.id})">Delete</button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">No candidates found</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading candidates:', error);
                    document.getElementById('candidatesTableBody').innerHTML = 
                        '<tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">Error loading candidates</td></tr>';
                });
        }

        function startEditCandidate(id, name, position, bio, photo) {
            editingCandidateId = id;
            const tbody = document.getElementById('candidatesTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                if (row.cells[3]?.querySelector(`button[onclick*="startEditCandidate(${id},"]`)) {
                    row.classList.add('editing-row');
                    row.innerHTML = `
                        <td><input type="text" class="edit-input" value="${name}" id="editName_${id}"></td>
                        <td>
                            <select class="edit-select" id="editPosition_${id}">
                                <option value="President" ${position === 'President' ? 'selected' : ''}>President</option>
                                <option value="Vice President" ${position === 'Vice President' ? 'selected' : ''}>Vice President</option>
                                <option value="Secretary" ${position === 'Secretary' ? 'selected' : ''}>Secretary</option>
                                <option value="Treasurer" ${position === 'Treasurer' ? 'selected' : ''}>Treasurer</option>
                                <option value="Auditor" ${position === 'Auditor' ? 'selected' : ''}>Auditor</option>
                            </select>
                        </td>
                        <td><span class="badge success">Editing</span></td>
                        <td class="actions">
                            <button class="secondary" onclick="saveCandidate(${id})">Save</button>
                            <button class="danger" onclick="cancelEditCandidate(${id})">Cancel</button>
                        </td>
                    `;
                    break;
                }
            }
        }

        function saveCandidate(id) {
            const name = document.getElementById(`editName_${id}`).value;
            const position = document.getElementById(`editPosition_${id}`).value;
            const bio = '';
            const photo = '';

            if (!name || !position) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Missing Fields',
                    text: 'Please fill in all fields',
                    confirmButtonColor: '#4e9eff',
                    background: '#1a1c20',
                    color: '#eaeaea'
                });
                return;
            }

            fetch('./backend/edit_candidate.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id, name, position, bio, photo })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showCandidateMessage('Candidate updated successfully!', 'success');
                    loadCandidates();
                } else {
                    showCandidateMessage('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showCandidateMessage('Network error: ' + error, 'error');
            });
        }

        function cancelEditCandidate(id) {
            loadCandidates();
        }

        function addCandidate(candidateData) {
            fetch('./backend/add_candidate.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(candidateData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showCandidateMessage('Candidate added successfully!', 'success');
                    closeCandidateModal();
                    loadCandidates();
                    loadStats();
                } else {
                    showCandidateMessage('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showCandidateMessage('Network error: ' + error, 'error');
            });
        }

        function deleteCandidate(candidateId) {
            Swal.fire({
                title: 'Delete Candidate',
                text: 'Are you sure you want to delete this candidate?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#9aa3ad',
                confirmButtonText: 'Yes, Delete',
                cancelButtonText: 'Cancel',
                background: '#1a1c20',
                color: '#eaeaea'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('./backend/delete_candidate.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ id: candidateId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showCandidateMessage('Candidate deleted successfully!', 'success');
                            loadCandidates();
                            loadStats();
                        } else {
                            showCandidateMessage('Error: ' + data.message, 'error');
                        }
                    })
                    .catch(error => {
                        showCandidateMessage('Network error: ' + error, 'error');
                    });
                }
            });
        }

        function showCandidateMessage(text, type) {
            const messageDiv = document.getElementById('candidateMessage');
            messageDiv.innerHTML = text;
            messageDiv.className = `message ${type}`;
            
            setTimeout(() => {
                messageDiv.innerHTML = '';
                messageDiv.className = '';
            }, 5000);
        }

        // Voter management functions
        let allVoters = [];
        
        function loadVoters() {
            fetch('./backend/get_voters.php?t=' + new Date().getTime())
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.voters) {
                        allVoters = data.voters.sort((a, b) => a.email.localeCompare(b.email));
                        displayVoters(allVoters);
                    } else {
                        document.getElementById('votersTableBody').innerHTML = '<tr><td colspan="5" style="text-align:center;padding:32px;color:var(--muted)">No voters found</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading voters:', error);
                    document.getElementById('votersTableBody').innerHTML = 
                        '<tr><td colspan="5" style="text-align:center;padding:32px;color:var(--muted)">Error loading voters</td></tr>';
                });
        }
        
        function displayVoters(voters) {
            const tbody = document.getElementById('votersTableBody');
            if (voters.length > 0) {
                tbody.innerHTML = '';
                voters.forEach(voter => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${escapeHtml(voter.name)}</strong></td>
                        <td>${escapeHtml(voter.email)}</td>
                        <td>${parseInt(voter.has_voted) === 1 ? '<span class="badge success">Voted</span>' : '<span class="badge muted">Not Voted</span>'}</td>
                        <td>
                            ${voter.status === 'active' ? '<span class="badge success">Active</span>' : 
                              voter.status === 'suspended' ? '<span class="badge danger">Suspended</span>' : 
                              '<span class="badge success">Active</span>'}
                        </td>
                        <td class="actions">
                            ${voter.status === 'suspended' ? 
                                `<button class="success" onclick="unsuspendVoter(${voter.id})">Unsuspend</button>` : 
                                `<button class="secondary" onclick="suspendVoter(${voter.id}, '${escapeHtml(voter.name)}')">Suspend</button>`
                            }
                            <button class="danger" onclick="deleteVoter(${voter.id}, '${escapeHtml(voter.name)}')">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:32px;color:var(--muted)">No voters found</td></tr>';
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('voterSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredVoters = allVoters.filter(voter => 
                        voter.name.toLowerCase().includes(searchTerm) || 
                        voter.email.toLowerCase().includes(searchTerm)
                    );
                    displayVoters(filteredVoters);
                });
            }
        });

        function suspendVoter(voterId, voterName) {
            document.getElementById('suspendVoterId').value = voterId;
            document.getElementById('suspendModal').classList.add('open');
            document.body.classList.add('modal-open');
        }

        function unsuspendVoter(voterId) {
            Swal.fire({
                title: 'Unsuspend Voter',
                text: 'Are you sure you want to unsuspend this voter?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#36c97e',
                cancelButtonColor: '#9aa3ad',
                confirmButtonText: 'Yes, Unsuspend',
                cancelButtonText: 'Cancel',
                background: '#1a1c20',
                color: '#eaeaea'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('./backend/unsuspend_voter.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ id: voterId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: 'Voter unsuspended successfully!',
                                showConfirmButton: false,
                                timer: 2000,
                                background: '#1a1c20',
                                color: '#eaeaea'
                            });
                            loadVoters();
                            loadRecentUsers();
                            loadStats();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message,
                                confirmButtonColor: '#4e9eff',
                                background: '#1a1c20',
                                color: '#eaeaea'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Network Error',
                            text: error.toString(),
                            confirmButtonColor: '#4e9eff',
                            background: '#1a1c20',
                            color: '#eaeaea'
                        });
                    });
                }
            });
        }

        function deleteVoter(voterId, voterName) {
            document.getElementById('deleteVoterId').value = voterId;
            document.getElementById('deleteModal').classList.add('open');
            document.body.classList.add('modal-open');
        }

  
        function openCandidateModal() {
            console.log('Opening candidate modal...');
            candidateModal.classList.add('open');
            document.body.classList.add('modal-open');
        }

        function closeCandidateModal() {
            candidateModal.classList.remove('open');
            candidateForm.reset();
            document.body.classList.remove('modal-open');
        }

        function closeSuspendModal() {
            suspendModal.classList.remove('open');
            suspendForm.reset();
            document.body.classList.remove('modal-open');
        }

        function closeDeleteModal() {
            deleteModal.classList.remove('open');
            document.body.classList.remove('modal-open');
        }

     
        candidateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('candidateName').value,
                position: document.getElementById('candidatePosition').value,
                bio: document.getElementById('candidateBio').value,
                photo: 'default_photo.jpg'
            };

            addCandidate(formData);
        });

        suspendForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const voterId = document.getElementById('suspendVoterId').value;
            const reason = document.getElementById('suspendReason').value;

            fetch('./backend/suspend_voter.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: voterId, reason: reason })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: 'Voter suspended successfully!',
                        showConfirmButton: false,
                        timer: 2000,
                        background: '#1a1c20',
                        color: '#eaeaea'
                    });
                    closeSuspendModal();
                    loadVoters();
                    loadRecentUsers();
                    loadStats();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message,
                        confirmButtonColor: '#4e9eff',
                        background: '#1a1c20',
                        color: '#eaeaea'
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Network Error',
                    text: error.toString(),
                    confirmButtonColor: '#4e9eff',
                    background: '#1a1c20',
                    color: '#eaeaea'
                });
            });
        });

        confirmDelete.addEventListener('click', function() {
            const voterId = document.getElementById('deleteVoterId').value;

            fetch('./backend/delete_voter.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: voterId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: 'Voter deleted successfully!',
                        showConfirmButton: false,
                        timer: 2000,
                        background: '#1a1c20',
                        color: '#eaeaea'
                    });
                    closeDeleteModal();
                    loadVoters();
                    loadRecentUsers();
                    loadStats();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message,
                        confirmButtonColor: '#4e9eff',
                        background: '#1a1c20',
                        color: '#eaeaea'
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Network Error',
                    text: error.toString(),
                    confirmButtonColor: '#4e9eff',
                    background: '#1a1c20',
                    color: '#eaeaea'
                });
            });
        });

        candidateModalCancel.addEventListener('click', closeCandidateModal);
        candidateModal.addEventListener('click', function(e) {
            if (e.target === candidateModal) closeCandidateModal();
        });

        suspendModalCancel.addEventListener('click', closeSuspendModal);
        suspendModal.addEventListener('click', function(e) {
            if (e.target === suspendModal) closeSuspendModal();
        });

        deleteModalCancel.addEventListener('click', closeDeleteModal);
        deleteModal.addEventListener('click', function(e) {
            if (e.target === deleteModal) closeDeleteModal();
        });

        
        addCandidateBtn.addEventListener('click', openCandidateModal);

      
        function escapeHtml(s) { 
            return (s+'').replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); 
        }

        let allArchivedCandidates = [];
        let allArchivedVoters = [];

        function loadArchivedCandidates() {
            fetch('./backend/get_archived_candidates.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.candidates) {
                        allArchivedCandidates = data.candidates;
                        displayArchivedCandidates(allArchivedCandidates);
                    } else {
                        document.getElementById('archivedCandidatesTableBody').innerHTML = '<tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">No archived candidates</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading archived candidates:', error);
                    document.getElementById('archivedCandidatesTableBody').innerHTML = '<tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">Error loading archived candidates</td></tr>';
                });
        }

        function displayArchivedCandidates(candidates) {
            const tbody = document.getElementById('archivedCandidatesTableBody');
            if (candidates.length > 0) {
                tbody.innerHTML = '';
                candidates.forEach(candidate => {
                    const archivedDate = new Date(candidate.archived_at).toLocaleString();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${escapeHtml(candidate.name)}</strong></td>
                        <td>${escapeHtml(candidate.position)}</td>
                        <td>${archivedDate}</td>
                        <td class="actions">
                            <button class="success" onclick="restoreCandidate(${candidate.id})">Restore</button>
                            <button class="danger" onclick="permanentlyDeleteCandidate(${candidate.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">No archived candidates</td></tr>';
            }
        }

        function loadArchivedVoters() {
            fetch('./backend/get_archived_voters.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.voters) {
                        allArchivedVoters = data.voters;
                        displayArchivedVoters(allArchivedVoters);
                    } else {
                        document.getElementById('archivedVotersTableBody').innerHTML = '<tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">No archived voters</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading archived voters:', error);
                    document.getElementById('archivedVotersTableBody').innerHTML = '<tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">Error loading archived voters</td></tr>';
                });
        }

        function displayArchivedVoters(voters) {
            const tbody = document.getElementById('archivedVotersTableBody');
            if (voters.length > 0) {
                tbody.innerHTML = '';
                voters.forEach(voter => {
                    const archivedDate = new Date(voter.archived_at).toLocaleString();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${escapeHtml(voter.name)}</strong></td>
                        <td>${escapeHtml(voter.email)}</td>
                        <td>${archivedDate}</td>
                        <td class="actions">
                            <button class="success" onclick="restoreVoter(${voter.id})">Restore</button>
                            <button class="danger" onclick="permanentlyDeleteVoter(${voter.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">No archived voters</td></tr>';
            }
        }

        function permanentlyDeleteCandidate(candidateId) {
            Swal.fire({
                title: 'Permanently Delete',
                text: 'Are you sure? This will permanently delete this candidate from the database!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#9aa3ad',
                confirmButtonText: 'Yes, Delete Permanently',
                cancelButtonText: 'Cancel',
                background: '#1a1c20',
                color: '#eaeaea'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('./backend/permanently_delete_candidate.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ id: candidateId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Deleted',
                                text: 'Candidate permanently deleted!',
                                showConfirmButton: false,
                                timer: 2000,
                                background: '#1a1c20',
                                color: '#eaeaea'
                            });
                            loadArchivedCandidates();
                            loadStats();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message,
                                confirmButtonColor: '#4e9eff',
                                background: '#1a1c20',
                                color: '#eaeaea'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Network Error',
                            text: error.toString(),
                            confirmButtonColor: '#4e9eff',
                            background: '#1a1c20',
                            color: '#eaeaea'
                        });
                    });
                }
            });
        }

        function permanentlyDeleteVoter(voterId) {
            Swal.fire({
                title: 'Permanently Delete',
                text: 'Are you sure? This will permanently delete this voter from the database!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#9aa3ad',
                confirmButtonText: 'Yes, Delete Permanently',
                cancelButtonText: 'Cancel',
                background: '#1a1c20',
                color: '#eaeaea'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('./backend/permanently_delete_voter.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ id: voterId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Deleted',
                                text: 'Voter permanently deleted!',
                                showConfirmButton: false,
                                timer: 2000,
                                background: '#1a1c20',
                                color: '#eaeaea'
                            });
                            loadArchivedVoters();
                            loadStats();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message,
                                confirmButtonColor: '#4e9eff',
                                background: '#1a1c20',
                                color: '#eaeaea'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Network Error',
                            text: error.toString(),
                            confirmButtonColor: '#4e9eff',
                            background: '#1a1c20',
                            color: '#eaeaea'
                        });
                    });
                }
            });
        }

        function restoreCandidate(candidateId) {
            Swal.fire({
                title: 'Restore Candidate',
                text: 'Are you sure you want to restore this candidate?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#36c97e',
                cancelButtonColor: '#9aa3ad',
                confirmButtonText: 'Yes, Restore',
                cancelButtonText: 'Cancel',
                background: '#1a1c20',
                color: '#eaeaea'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('./backend/restore_candidate.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: candidateId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: 'Candidate restored successfully!',
                                showConfirmButton: false,
                                timer: 2000,
                                background: '#1a1c20',
                                color: '#eaeaea'
                            });
                            loadArchivedCandidates();
                            loadCandidates();
                            loadStats();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message,
                                confirmButtonColor: '#4e9eff',
                                background: '#1a1c20',
                                color: '#eaeaea'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: error.toString(),
                            confirmButtonColor: '#4e9eff',
                            background: '#1a1c20',
                            color: '#eaeaea'
                        });
                    });
                }
            });
        }

        function restoreVoter(voterId) {
            Swal.fire({
                title: 'Restore Voter',
                text: 'Are you sure you want to restore this voter?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#36c97e',
                cancelButtonColor: '#9aa3ad',
                confirmButtonText: 'Yes, Restore',
                cancelButtonText: 'Cancel',
                background: '#1a1c20',
                color: '#eaeaea'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('./backend/restore_voter.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: voterId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: 'Voter restored successfully!',
                                showConfirmButton: false,
                                timer: 2000,
                                background: '#1a1c20',
                                color: '#eaeaea'
                            });
                            loadArchivedVoters();
                            loadVoters();
                            loadStats();
                            loadRecentUsers();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message,
                                confirmButtonColor: '#4e9eff',
                                background: '#1a1c20',
                                color: '#eaeaea'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: error.toString(),
                            confirmButtonColor: '#4e9eff',
                            background: '#1a1c20',
                            color: '#eaeaea'
                        });
                    });
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const archivedCandidateSearch = document.getElementById('archivedCandidateSearch');
            if (archivedCandidateSearch) {
                archivedCandidateSearch.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const filtered = allArchivedCandidates.filter(c => 
                        c.name.toLowerCase().includes(searchTerm) || 
                        c.position.toLowerCase().includes(searchTerm)
                    );
                    displayArchivedCandidates(filtered);
                });
            }

            const archivedVoterSearch = document.getElementById('archivedVoterSearch');
            if (archivedVoterSearch) {
                archivedVoterSearch.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const filtered = allArchivedVoters.filter(v => 
                        v.name.toLowerCase().includes(searchTerm) || 
                        v.email.toLowerCase().includes(searchTerm)
                    );
                    displayArchivedVoters(filtered);
                });
            }
        });

        function permanentlyDeleteCandidate(candidateId) {
            Swal.fire({
                title: 'Permanently Delete',
                text: 'Are you sure? This will permanently delete this candidate from the database!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#9aa3ad',
                confirmButtonText: 'Yes, Delete Permanently',
                cancelButtonText: 'Cancel',
                background: '#1a1c20',
                color: '#eaeaea'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('./backend/permanently_delete_candidate.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ id: candidateId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Deleted',
                                text: 'Candidate permanently deleted!',
                                showConfirmButton: false,
                                timer: 2000,
                                background: '#1a1c20',
                                color: '#eaeaea'
                            });
                            loadArchivedCandidates();
                            loadStats();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message,
                                confirmButtonColor: '#4e9eff',
                                background: '#1a1c20',
                                color: '#eaeaea'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Network Error',
                            text: error.toString(),
                            confirmButtonColor: '#4e9eff',
                            background: '#1a1c20',
                            color: '#eaeaea'
                        });
                    });
                }
            });
        }

        function permanentlyDeleteVoter(voterId) {
            Swal.fire({
                title: 'Permanently Delete',
                text: 'Are you sure? This will permanently delete this voter from the database!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#9aa3ad',
                confirmButtonText: 'Yes, Delete Permanently',
                cancelButtonText: 'Cancel',
                background: '#1a1c20',
                color: '#eaeaea'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('./backend/permanently_delete_voter.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ id: voterId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Deleted',
                                text: 'Voter permanently deleted!',
                                showConfirmButton: false,
                                timer: 2000,
                                background: '#1a1c20',
                                color: '#eaeaea'
                            });
                            loadArchivedVoters();
                            loadStats();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message,
                                confirmButtonColor: '#4e9eff',
                                background: '#1a1c20',
                                color: '#eaeaea'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Network Error',
                            text: error.toString(),
                            confirmButtonColor: '#4e9eff',
                            background: '#1a1c20',
                            color: '#eaeaea'
                        });
                    });
                }
            });
        }

        function escapeHtml(s) { 
            return (s+'').replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); 
        }

       
        showView('overview');
        loadCandidates();
        loadStats();
        loadElectionSettings();
        loadRecentUsers();
    </script>
</body>
</html>