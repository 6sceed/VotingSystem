<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Voting Assistance — Admin Dashboard</title>
    <link rel="stylesheet" href="./asset/style/admindb.css">
</head>
<body>
    <header>
        <h1>Voting System Admin Dashboard</h1>
        <div class="controls">
         
        </div>
    </header>

    <div class="layout">
        <nav aria-label="Main navigation">
            <a href="#" class="nav-item active" data-view="overview">
                Overview
            </a>
            <a href="#" class="nav-item" data-view="candidates">
                Election
            </a>
            <a href="#" class="nav-item" data-view="voters">
                Voters
            </a>
            <a href="#" class="nav-item" data-view="results">
                Results
            </a>
            <hr style="border:none;height:1px;background:var(--border);margin:16px 20px;">
            <a href="#" class="nav-item" id="logoutBtn">
                Logout
            </a>
        </nav>

        <main>
            <!-- Overview -->
            <section id="view-overview" class="view">
                <div class="row">
                    <div class="card stat">
                        <h3>Total Voters</h3>
                        <p id="totalVoters">0</p>
                    </div>
                    <div class="card stat">
                        <h3>Total Candidates</h3>
                        <p id="totalCandidates">0</p>
                    </div>
                    <div class="card stat">
                        <h3>Total Votes Cast</h3>
                        <p id="totalVotes">0</p>
                    </div>
                </div>

                <!-- Recent Users Section -->
                <div class="card" style="margin-top:24px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                        <h3 style="margin:0;color:var(--text);">Recent Registered Users</h3>
                        <button id="refreshRecentUsers" class="secondary">Refresh</button>
                    </div>
                    <div id="recentUsersList">
                        <div style="text-align:center;padding:32px;color:var(--muted)">Loading recent users...</div>
                    </div>
                </div>
            </section>

            <!-- Candidates -->
            <section id="view-candidates" class="view" style="display:none">
                <!-- Election Configuration -->
                <div class="card" style="margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                        <h3 style="margin:0;color:var(--text);">Election Controls</h3>
                        <div class="election-controls">
                            <button id="startVotingBtn" class="success">Start Voting</button>
                            <button id="stopVotingBtn" class="danger" style="display:none;">Stop Voting</button>
                            <button id="resetAllBtn" class="danger" title="Reset all votes">Reset All Votes</button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label for="electionTitle">Election Title</label>
                            <input type="text" id="electionTitle" name="election_title" required placeholder="Enter election title">
                        </div>
                        <div class="form-group">
                            <label for="electionDescription">Description</label>
                            <input type="text" id="electionDescription" name="election_description" placeholder="Brief description">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 16px;">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="datetime-local" id="startDate" name="start_date" required>
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <input type="datetime-local" id="endDate" name="end_date" required>
                        </div>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:20px">
                        <div class="muted" id="electionStatus">Status: Not configured</div>
                        <button type="button" id="resetSettings" class="secondary">Reset Form</button>
                    </div>
                </div>

                <!-- Candidate Management -->
                <div class="card" style="margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <h3 style="margin:0;color:var(--text);">Candidate Management</h3>
                        <div>
                            <button id="addCandidateBtn2">Add New Candidate</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div id="candidateMessage"></div>
                    <table id="candidatesTable" aria-describedby="candidates">
                        <thead>
                            <tr><th>Candidate</th><th>Position</th><th>Status</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="candidatesTableBody">
                            <tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">Loading candidates...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Voters -->
            <section id="view-voters" class="view" style="display:none">
                <div class="card" style="margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <h3 style="margin:0;color:var(--text);">Registered Voters</h3>
                        <div>
                            <button id="addVoterBtn2">New Voter</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div id="voterMessage"></div>
                    <table id="votersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Has Voted</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="votersTableBody">
                            <tr><td colspan="5" style="text-align:center;padding:32px;color:var(--muted)">Loading voters...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Results -->
            <section id="view-results" class="view" style="display:none">
                <div class="card" style="margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <h3 style="margin:0;color:var(--text);">Live Results</h3>
                        <div>
                            <button id="refreshResultsBtn" class="secondary">Refresh Results</button>
                            <button id="exportResultsBtn" class="secondary">Export Results</button>
                        </div>
                    </div>
                </div>

                <div class="results-container">
                    <div class="card">
                        <h3 style="margin:0 0 20px 0;color:var(--text);">Vote Statistics</h3>
                        <div id="resultsList"></div>
                    </div>
                    
                    <div class="chart-container">
                        <h3 style="margin:0 0 20px 0;color:var(--text);">Live Vote Chart</h3>
                        <div id="resultsChart" class="chart-placeholder">
                            Loading live results...
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Candidate Modal -->
    <div class="modal" id="candidateModal">
        <div class="card" role="dialog" aria-modal="true" aria-labelledby="candidateModalTitle">
            <h3 id="candidateModalTitle" style="margin:0 0 20px 0;color:var(--text);">Add New Candidate</h3>
            <form id="candidateForm">
                <div id="candidateModalBody">
                    <div class="form-group">
                        <label for="candidateName">Candidate Name</label>
                        <input type="text" id="candidateName" name="name" required placeholder="Enter full name">
                    </div>
                    <div class="form-group">
                        <label for="candidatePosition">Position</label>
                        <select id="candidatePosition" name="position" required>
                            <option value="">Select Position</option>
                            <option value="President">President</option>
                            <option value="Vice President">Vice President</option>
                            <option value="Secretary">Secretary</option>
                            <option value="Treasurer">Treasurer</option>
                            <option value="Auditor">Auditor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="candidateBio">Biography/Description</label>
                        <textarea id="candidateBio" name="bio" placeholder="Brief description about the candidate"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="candidatePhoto">Photo URL (optional)</label>
                        <input type="text" id="candidatePhoto" name="photo" placeholder="Enter image URL">
                    </div>
                </div>
                <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:24px">
                    <button type="button" id="candidateModalCancel" class="secondary">Cancel</button>
                    <button type="submit">Save Candidate</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Suspend Voter Modal -->
    <div class="modal" id="suspendModal">
        <div class="card" role="dialog" aria-modal="true">
            <h3 style="margin:0 0 20px 0;color:var(--text);">Suspend Voter Account</h3>
            <form id="suspendForm">
                <input type="hidden" id="suspendVoterId">
                <div class="form-group">
                    <label for="suspendReason">Reason for Suspension</label>
                    <textarea id="suspendReason" name="reason" required placeholder="Enter the reason for suspending this account..." rows="4"></textarea>
                </div>
                <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:24px">
                    <button type="button" id="suspendModalCancel" class="secondary">Cancel</button>
                    <button type="submit" class="danger">Suspend Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Voter Modal -->
    <div class="modal" id="deleteModal">
        <div class="card" role="dialog" aria-modal="true">
            <h3 style="margin:0 0 16px 0;color:var(--text);">Delete Voter Account</h3>
            <p style="color: var(--muted); margin-bottom: 24px; line-height: 1.6;">Are you sure you want to delete this voter account? This action cannot be undone and the user will no longer be able to log in.</p>
            <input type="hidden" id="deleteVoterId">
            <div style="display:flex;justify-content:flex-end;gap:12px">
                <button type="button" id="deleteModalCancel" class="secondary">Cancel</button>
                <button type="button" id="confirmDelete" class="danger">Delete Account</button>
            </div>
        </div>
    </div>

    <footer>Voting Assistance System © 2024</footer>

    <script>
        // DOM refs
        const views = document.querySelectorAll('.view');
        const navItems = document.querySelectorAll('.nav-item');
        const candidateModal = document.getElementById('candidateModal');
        const candidateForm = document.getElementById('candidateForm');
        const candidateModalCancel = document.getElementById('candidateModalCancel');
        const suspendModal = document.getElementById('suspendModal');
        const suspendForm = document.getElementById('suspendForm');
        const suspendModalCancel = document.getElementById('suspendModalCancel');
        const deleteModal = document.getElementById('deleteModal');
        const deleteModalCancel = document.getElementById('deleteModalCancel');
        const confirmDelete = document.getElementById('confirmDelete');
        const logoutBtn = document.getElementById('logoutBtn');
        const exportResultsBtn = document.getElementById('exportResultsBtn');

        let editingCandidateId = null;
        let currentVotingState = false;
        let resultsInterval = null;

        // Navigation
        navItems.forEach(a => {
            a.addEventListener('click', e => {
                e.preventDefault();
                navItems.forEach(n => n.classList.remove('active'));
                a.classList.add('active');
                const view = a.dataset.view;
                showView(view);
            });
        });

        function showView(name) {
            views.forEach(v => v.style.display = v.id === 'view-' + name ? '' : 'none');
            if (name === 'candidates') {
                loadCandidates();
                loadElectionSettings(); 
            } else if (name === 'voters') {
                loadVoters();
            } else if (name === 'results') {
                loadResults();
                startResultsAutoRefresh();
            } else if (name === 'overview') {
                loadRecentUsers();
            } else {
                stopResultsAutoRefresh();
            }
            updateVotingControls(currentVotingState);
        }

        // Results auto-refresh
        function startResultsAutoRefresh() {
            resultsInterval = setInterval(loadResults, 5000);
        }

        function stopResultsAutoRefresh() {
            if (resultsInterval) {
                clearInterval(resultsInterval);
                resultsInterval = null;
            }
        }

        // Reset all votes function
        function resetAllVotes() {
            if (confirm('DANGER ZONE! This will DELETE ALL VOTES permanently!\n\nAll users will be able to vote again.\nThis cannot be undone!\n\nClick OK to continue or Cancel to abort.')) {
                fetch('./backend/reset_votes.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: 'admin123' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('All votes reset successfully! Users can now vote again.');
                        loadStats();
                        if (document.getElementById('view-voters').style.display !== 'none') {
                            loadVoters();
                        }
                    } else {
                        alert('Reset failed: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Network error: ' + error);
                });
            }
        }

        // Load stats for overview
        function loadStats() {
            // Load total voters
            fetch('./backend/get_voters.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.voters) {
                        document.getElementById('totalVoters').textContent = data.voters.length;
                    }
                });

            // Load total candidates
            fetch('./backend/get_candidates.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.candidates) {
                        document.getElementById('totalCandidates').textContent = data.candidates.length;
                    }
                });

            // Load total votes
            fetch('./backend/get_votes_count.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('totalVotes').textContent = data.total_votes || 0;
                    }
                });
        }

        // Load recent users
        function loadRecentUsers() {
            fetch('./backend/get_voters.php')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('recentUsersList');
                    if (data.success && data.voters && data.voters.length > 0) {
                        // Get the 5 most recent voters (assuming newer IDs are more recent)
                        const recentVoters = data.voters
                            .sort((a, b) => b.id - a.id)
                            .slice(0, 5);
                        
                        let html = '<div class="recent-users-list">';
                        
                        recentVoters.forEach(voter => {
                            html += `
                                <div class="recent-user-item">
                                    <div class="user-avatar">${getInitials(voter.name)}</div>
                                    <div class="user-info">
                                        <div class="user-name">${escapeHtml(voter.name)}</div>
                                        <div class="user-email">${escapeHtml(voter.email)}</div>
                                        <div class="user-status">
                                            ${parseInt(voter.has_voted) === 1 ? '<span class="badge success">Voted</span>' : '<span class="badge muted">Not Voted</span>'}
                                            ${voter.status === 'suspended' ? '<span class="badge danger">Suspended</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<div style="text-align:center;padding:32px;color:var(--muted)">No users found</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading recent users:', error);
                    document.getElementById('recentUsersList').innerHTML = 
                        '<div style="text-align:center;padding:32px;color:var(--muted)">Error loading recent users</div>';
                });
        }

        // Helper function to get initials from name
        function getInitials(name) {
            return name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2);
        }

        // Load election settings
        function loadElectionSettings() {
            fetch('./backend/get_election_settings.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.settings) {
                        const settings = data.settings;
                        document.getElementById('electionTitle').value = settings.election_title || '';
                        document.getElementById('electionDescription').value = settings.election_description || '';
                        
                        const formatDateForInput = (dateString) => {
                            if (!dateString) return '';
                            const date = new Date(dateString);
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            const hours = String(date.getHours()).padStart(2, '0');
                            const minutes = String(date.getMinutes()).padStart(2, '0');
                            return `${year}-${month}-${day}T${hours}:${minutes}`;
                        };
                        
                        document.getElementById('startDate').value = formatDateForInput(settings.start_date);
                        document.getElementById('endDate').value = formatDateForInput(settings.end_date);
                        
                        currentVotingState = settings.is_active || false;
                        updateVotingControls(currentVotingState);
                        updateElectionStatusDisplay(currentVotingState);
                    }
                })
                .catch(error => {
                    console.error('Error loading election settings:', error);
                });
        }

        // Update voting control buttons
        function updateVotingControls(isActive) {
            const startBtn = document.getElementById('startVotingBtn');
            const stopBtn = document.getElementById('stopVotingBtn');
            
            if (isActive) {
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
            } else {
                startBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
            }
        }

        // Update election status display
        function updateElectionStatusDisplay(isActive) {
            const statusElement = document.getElementById('electionStatus');
            if (isActive) {
                statusElement.innerHTML = 'Status: <span style="color:#10b981;font-weight:600">Voting ACTIVE</span>';
            } else {
                statusElement.innerHTML = 'Status: <span style="color:#ef4444;font-weight:600">Voting INACTIVE</span>';
            }
        }

        // Start voting - saves configuration AND starts voting
        document.getElementById('startVotingBtn').addEventListener('click', function() {
            const title = document.getElementById('electionTitle').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!title || !startDate || !endDate) {
                alert('Please fill in Election Title, Start Date, and End Date before starting voting.');
                return;
            }
            
            if (confirm('Start voting now? This will allow users to cast their votes.')) {
                updateVotingStatus(1);
            }
        });

        // Stop voting
        document.getElementById('stopVotingBtn').addEventListener('click', function() {
            if (confirm('Stop voting now? This will prevent users from casting new votes.')) {
                updateVotingStatus(0);
            }
        });

        // Reset all votes button
        document.getElementById('resetAllBtn').addEventListener('click', resetAllVotes);

        // Update voting status in database
        function updateVotingStatus(isActive, showAlert = true) {
            const settings = {
                election_title: document.getElementById('electionTitle').value,
                election_description: document.getElementById('electionDescription').value,
                start_date: document.getElementById('startDate').value.replace('T', ' ') + ':00',
                end_date: document.getElementById('endDate').value.replace('T', ' ') + ':00',
                is_active: isActive
            };
            
            fetch('./backend/save_election_settings.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentVotingState = isActive;
                    updateVotingControls(isActive);
                    updateElectionStatusDisplay(isActive);
                    
                    if (isActive) {
                        if (showAlert) alert('Voting started successfully!');
                    } else {
                        if (showAlert) alert('Voting stopped successfully!');
                    }
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Network error: ' + error);
            });
        }

        // Load and display live results
        function loadResults() {
            fetch('./backend/get_live_results.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.results) {
                        displayResults(data.results);
                        updateResultsChart(data.results);
                    } else {
                        document.getElementById('resultsList').innerHTML = 
                            '<div style="text-align:center;padding:32px;color:var(--muted)">No results available yet</div>';
                        document.getElementById('resultsChart').innerHTML = 
                            '<div class="chart-placeholder">No data available for chart</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading results:', error);
                    document.getElementById('resultsList').innerHTML = 
                        '<div style="text-align:center;padding:32px;color:var(--muted)">Error loading results</div>';
                    document.getElementById('resultsChart').innerHTML = 
                        '<div class="chart-placeholder">Error loading chart data</div>';
                });
        }

        // Display results in list format grouped by position
        function displayResults(results) {
            const resultsList = document.getElementById('resultsList');
            
            const resultsByPosition = {};
            results.forEach(candidate => {
                if (!resultsByPosition[candidate.position]) {
                    resultsByPosition[candidate.position] = [];
                }
                resultsByPosition[candidate.position].push(candidate);
            });
            
            Object.keys(resultsByPosition).forEach(position => {
                resultsByPosition[position].sort((a, b) => b.vote_count - a.vote_count);
                if (resultsByPosition[position].length > 0 && resultsByPosition[position][0].vote_count > 0) {
                    resultsByPosition[position][0].isLeading = true;
                }
            });
            
            let html = '';
            
            Object.keys(resultsByPosition).sort().forEach(position => {
                const positionResults = resultsByPosition[position];
                const totalVotes = positionResults.reduce((sum, candidate) => sum + candidate.vote_count, 0);
                
                html += `
                    <div class="position-section">
                        <div class="position-header">${escapeHtml(position)}</div>
                `;
                
                positionResults.forEach(candidate => {
                    const percentage = totalVotes > 0 ? ((candidate.vote_count / totalVotes) * 100).toFixed(1) : 0;
                    
                    html += `
                        <div class="result-item ${candidate.isLeading ? 'leading' : ''}">
                            <div class="candidate-name">
                                ${escapeHtml(candidate.name)}
                                ${candidate.isLeading ? '<span class="leading-badge">LEADING</span>' : ''}
                            </div>
                            <div class="vote-progress">
                                <div class="vote-bar" style="width: ${percentage}%; background: ${getPositionColor(position)}"></div>
                            </div>
                            <div class="vote-count">
                                <span>${candidate.vote_count} votes</span>
                                <span>${percentage}%</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            resultsList.innerHTML = html || '<div style="text-align:center;padding:32px;color:var(--muted)">No votes cast yet</div>';
        }

        // Update results chart grouped by position
        function updateResultsChart(results) {
            const chartContainer = document.getElementById('resultsChart');
            
            const resultsByPosition = {};
            results.forEach(candidate => {
                if (!resultsByPosition[candidate.position]) {
                    resultsByPosition[candidate.position] = [];
                }
                resultsByPosition[candidate.position].push(candidate);
            });
            
            Object.keys(resultsByPosition).forEach(position => {
                resultsByPosition[position].sort((a, b) => b.vote_count - a.vote_count);
                if (resultsByPosition[position].length > 0 && resultsByPosition[position][0].vote_count > 0) {
                    resultsByPosition[position][0].isLeading = true;
                }
            });
            
            let html = '';
            
            Object.keys(resultsByPosition).sort().forEach(position => {
                const positionResults = resultsByPosition[position];
                const totalVotes = positionResults.reduce((sum, candidate) => sum + candidate.vote_count, 0);
                
                html += `
                    <div class="chart-section">
                        <div class="chart-section-header">
                            <span>${escapeHtml(position)}</span>
                        </div>
                `;
                
                positionResults.forEach(candidate => {
                    const percentage = totalVotes > 0 ? ((candidate.vote_count / totalVotes) * 100).toFixed(1) : 0;
                    
                    html += `
                        <div class="chart-candidate ${candidate.isLeading ? 'leading' : ''}">
                            <div class="chart-candidate-name">${escapeHtml(candidate.name)}</div>
                            <div class="chart-bar-container">
                                <div class="chart-bar" style="width: ${percentage}%; background: ${getPositionColor(position)}">
                                    <span class="chart-bar-percentage">${percentage}%</span>
                                </div>
                            </div>
                            <div class="chart-votes">${candidate.vote_count} votes</div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            chartContainer.innerHTML = html || '<div class="chart-placeholder">No data available</div>';
        }

        // Helper function to get color based on position
        function getPositionColor(position) {
            const colors = {
                'President': '#3b82f6',
                'Vice President': '#10b981',
                'Secretary': '#f59e0b',
                'Treasurer': '#ef4444',
                'Auditor': '#8b5cf6'
            };
            return colors[position] || '#6b7280';
        }

        // Export results functionality
        exportResultsBtn.addEventListener('click', function() {
            fetch('./backend/get_live_results.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.results) {
                        exportToCSV(data.results);
                    } else {
                        alert('No results available to export.');
                    }
                })
                .catch(error => {
                    alert('Error fetching results for export: ' + error);
                });
        });

        function exportToCSV(results) {
            const resultsByPosition = {};
            results.forEach(candidate => {
                if (!resultsByPosition[candidate.position]) {
                    resultsByPosition[candidate.position] = [];
                }
                resultsByPosition[candidate.position].push(candidate);
            });

            let csvContent = 'Election Results\n\n';
            
            Object.keys(resultsByPosition).sort().forEach(position => {
                const positionResults = resultsByPosition[position];
                const totalVotes = positionResults.reduce((sum, candidate) => sum + candidate.vote_count, 0);
                
                positionResults.sort((a, b) => b.vote_count - a.vote_count);
                
                csvContent += `${position}\n`;
                csvContent += 'Candidate,Votes,Percentage,Status\n';
                
                positionResults.forEach((candidate, index) => {
                    const percentage = totalVotes > 0 ? ((candidate.vote_count / totalVotes) * 100).toFixed(2) : '0.00';
                    const status = index === 0 && candidate.vote_count > 0 ? 'Leading' : '';
                    
                    csvContent += `"${candidate.name}",${candidate.vote_count},${percentage}%,${status}\n`;
                });
                
                csvContent += '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `election-results-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Results exported successfully!');
        }

        // Refresh results button
        document.getElementById('refreshResultsBtn').addEventListener('click', function() {
            loadResults();
        });

        // Refresh recent users button
        document.getElementById('refreshRecentUsers').addEventListener('click', function() {
            loadRecentUsers();
            loadStats();
        });

        // Logout functionality
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Are you sure you want to logout?')) {
                fetch('./backend/logout.php', {
                    method: 'POST'
                })
                .then(response => {
                    window.location.href = 'index.html';
                })
                .catch(error => {
                    window.location.href = 'index.html';
                });
            }
        });

        // Candidate management functions
        function loadCandidates() {
            fetch('./backend/get_candidates.php')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('candidatesTableBody');
                    if (data.success && data.candidates) {
                        tbody.innerHTML = '';
                        data.candidates.forEach(candidate => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td><strong>${escapeHtml(candidate.name)}</strong></td>
                                <td>${escapeHtml(candidate.position)}</td>
                                <td>${candidate.is_active ? '<span class="badge success">Active</span>' : '<span class="badge danger">Inactive</span>'}</td>
                                <td class="actions">
                                    <button class="secondary" onclick="startEditCandidate(${candidate.id}, '${escapeHtml(candidate.name)}', '${escapeHtml(candidate.position)}', '${escapeHtml(candidate.bio || '')}', '${escapeHtml(candidate.photo || '')}')">Edit</button>
                                    <button class="danger" onclick="deleteCandidate(${candidate.id})">Delete</button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">No candidates found</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading candidates:', error);
                    document.getElementById('candidatesTableBody').innerHTML = 
                        '<tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">Error loading candidates</td></tr>';
                });
        }

        function startEditCandidate(id, name, position, bio, photo) {
            editingCandidateId = id;
            const tbody = document.getElementById('candidatesTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                if (row.cells[3]?.querySelector(`button[onclick*="startEditCandidate(${id},"]`)) {
                    row.classList.add('editing-row');
                    row.innerHTML = `
                        <td><input type="text" class="edit-input" value="${name}" id="editName_${id}"></td>
                        <td>
                            <select class="edit-select" id="editPosition_${id}">
                                <option value="President" ${position === 'President' ? 'selected' : ''}>President</option>
                                <option value="Vice President" ${position === 'Vice President' ? 'selected' : ''}>Vice President</option>
                                <option value="Secretary" ${position === 'Secretary' ? 'selected' : ''}>Secretary</option>
                                <option value="Treasurer" ${position === 'Treasurer' ? 'selected' : ''}>Treasurer</option>
                                <option value="Auditor" ${position === 'Auditor' ? 'selected' : ''}>Auditor</option>
                            </select>
                        </td>
                        <td><span class="badge success">Editing</span></td>
                        <td class="actions">
                            <button class="secondary" onclick="saveCandidate(${id})">Save</button>
                            <button class="danger" onclick="cancelEditCandidate(${id})">Cancel</button>
                        </td>
                    `;
                    break;
                }
            }
        }

        function saveCandidate(id) {
            const name = document.getElementById(`editName_${id}`).value;
            const position = document.getElementById(`editPosition_${id}`).value;
            const bio = '';
            const photo = '';

            if (!name || !position) {
                alert('Please fill in all fields');
                return;
            }

            fetch('./backend/edit_candidate.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id, name, position, bio, photo })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showCandidateMessage('Candidate updated successfully!', 'success');
                    loadCandidates();
                } else {
                    showCandidateMessage('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showCandidateMessage('Network error: ' + error, 'error');
            });
        }

        function cancelEditCandidate(id) {
            loadCandidates();
        }

        function addCandidate(candidateData) {
            fetch('./backend/add_candidate.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(candidateData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showCandidateMessage('Candidate added successfully!', 'success');
                    candidateModal.classList.remove('open');
                    candidateForm.reset();
                    loadCandidates();
                    loadStats();
                } else {
                    showCandidateMessage('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showCandidateMessage('Network error: ' + error, 'error');
            });
        }

        function deleteCandidate(candidateId) {
            if (confirm('Are you sure you want to delete this candidate?')) {
                fetch('./backend/delete_candidate.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: candidateId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showCandidateMessage('Candidate deleted successfully!', 'success');
                        loadCandidates();
                        loadStats();
                    } else {
                        showCandidateMessage('Error: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showCandidateMessage('Network error: ' + error, 'error');
                });
            }
        }

        function showCandidateMessage(text, type) {
            const messageDiv = document.getElementById('candidateMessage');
            messageDiv.innerHTML = text;
            messageDiv.className = `message ${type}`;
            
            setTimeout(() => {
                messageDiv.innerHTML = '';
                messageDiv.className = '';
            }, 5000);
        }

        // Voter management functions
        function loadVoters() {
            fetch('./backend/get_voters.php')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('votersTableBody');
                    if (data.success && data.voters) {
                        tbody.innerHTML = '';
                        data.voters.forEach(voter => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td><strong>${escapeHtml(voter.name)}</strong></td>
                                <td>${escapeHtml(voter.email)}</td>
                                <td>${parseInt(voter.has_voted) === 1 ? '<span class="badge success">Voted</span>' : '<span class="badge muted">Not Voted</span>'}</td>
                                <td>
                                    ${voter.status === 'active' ? '<span class="badge success">Active</span>' : 
                                      voter.status === 'suspended' ? '<span class="badge danger">Suspended</span>' : 
                                      '<span class="badge success">Active</span>'}
                                </td>
                                <td class="actions">
                                    ${voter.status === 'suspended' ? 
                                        `<button class="success" onclick="unsuspendVoter(${voter.id})">Unsuspend</button>` : 
                                        `<button class="secondary" onclick="suspendVoter(${voter.id}, '${escapeHtml(voter.name)}')">Suspend</button>`
                                    }
                                    <button class="danger" onclick="deleteVoter(${voter.id}, '${escapeHtml(voter.name)}')">Delete</button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:32px;color:var(--muted)">No voters found</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading voters:', error);
                    document.getElementById('votersTableBody').innerHTML = 
                        '<tr><td colspan="5" style="text-align:center;padding:32px;color:var(--muted)">Error loading voters</td></tr>';
                });
        }

        function suspendVoter(voterId, voterName) {
            document.getElementById('suspendVoterId').value = voterId;
            document.getElementById('suspendModal').classList.add('open');
            document.body.classList.add('modal-open');
        }

        function unsuspendVoter(voterId) {
            if (confirm('Are you sure you want to unsuspend this voter?')) {
                fetch('./backend/unsuspend_voter.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: voterId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Voter unsuspended successfully!');
                        loadVoters();
                    loadRecentUsers();
                    loadStats();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Network error: ' + error);
                });
            }
        }

        function deleteVoter(voterId, voterName) {
            document.getElementById('deleteVoterId').value = voterId;
            document.getElementById('deleteModal').classList.add('open');
            document.body.classList.add('modal-open');
        }

        // Modal controls
        function openCandidateModal() {
            candidateModal.classList.add('open');
            document.body.classList.add('modal-open');
        }

        function closeCandidateModal() {
            candidateModal.classList.remove('open');
            candidateForm.reset();
            document.body.classList.remove('modal-open');
        }

        function closeSuspendModal() {
            suspendModal.classList.remove('open');
            suspendForm.reset();
            document.body.classList.remove('modal-open');
        }

        function closeDeleteModal() {
            deleteModal.classList.remove('open');
            document.body.classList.remove('modal-open');
        }

        // Event listeners
        candidateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('candidateName').value,
                position: document.getElementById('candidatePosition').value,
                bio: document.getElementById('candidateBio').value,
                photo: document.getElementById('candidatePhoto').value || 'default_photo.jpg'
            };

            addCandidate(formData);
        });

        suspendForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const voterId = document.getElementById('suspendVoterId').value;
            const reason = document.getElementById('suspendReason').value;

            fetch('./backend/suspend_voter.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: voterId, reason: reason })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Voter suspended successfully!');
                    closeSuspendModal();
                    loadVoters();
                    loadRecentUsers();
                    loadStats();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Network error: ' + error);
            });
        });

        confirmDelete.addEventListener('click', function() {
            const voterId = document.getElementById('deleteVoterId').value;

            fetch('./backend/delete_voter.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: voterId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Voter deleted successfully!');
                    closeDeleteModal();
                    loadVoters();
                    loadRecentUsers();
                    loadStats();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Network error: ' + error);
            });
        });

        candidateModalCancel.addEventListener('click', closeCandidateModal);
        candidateModal.addEventListener('click', function(e) {
            if (e.target === candidateModal) closeCandidateModal();
        });

        suspendModalCancel.addEventListener('click', closeSuspendModal);
        suspendModal.addEventListener('click', function(e) {
            if (e.target === suspendModal) closeSuspendModal();
        });

        deleteModalCancel.addEventListener('click', closeDeleteModal);
        deleteModal.addEventListener('click', function(e) {
            if (e.target === deleteModal) closeDeleteModal();
        });

        // Add candidate buttons
        document.getElementById('addCandidateBtn').addEventListener('click', openCandidateModal);
        document.getElementById('addCandidateBtn2').addEventListener('click', openCandidateModal);

        // Helper function
        function escapeHtml(s) { 
            return (s+'').replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); 
        }

        // Initialize
        showView('overview');
        loadCandidates();
        loadStats();
        loadElectionSettings();
        loadRecentUsers();
    </script>
</body>
</html>