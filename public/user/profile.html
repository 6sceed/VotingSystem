<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VotingEase</title>
<style>
:root {
  --bg: #121417;
  --header-bg: #1d1f23;
  --header-text: #f2f2f2;
  --accent: #4e9eff;
  --shadow: rgba(0, 0, 0, 0.6);
}
body {
  font-family: "Inter", Arial, sans-serif;
  background: var(--bg);
  color: var(--header-text);
  margin: 0;
}
/* ===== HEADER ===== */
header {
  background: var(--header-bg);
  color: var(--header-text);
  padding: 14px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 8px var(--shadow);
  position: sticky;
  top: 0;
  z-index: 100;
}
.logo {
  font-weight: 800;
  font-size: 20px;
  color: var(--accent);
}
.menu {
  position: relative;
  display: flex;
  align-items: center;
  gap: 18px;
}
.menu-links {
  display: flex;
  gap: 18px;
  align-items: center;
}
.menu-links a {
  text-decoration: none;
  color: var(--header-text);
  font-weight: 500;
  font-size: 15px;
  transition: opacity 0.2s ease;
}
.menu-links a:hover {
  opacity: 0.7;
}
.menu-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 6px;
}
.menu-btn div {
  width: 22px;
  height: 2px;
  background: var(--header-text);
  margin: 5px 0;
  transition: 0.3s;
}
.dropdown {
  display: none;
  position: absolute;
  right: 0;
  top: 42px;
  background: #23262b;
  border-radius: 6px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
  min-width: 160px;
  overflow: hidden;
  z-index: 999;
}
.dropdown a {
  display: block;
  padding: 10px 14px;
  text-decoration: none;
  color: #eaeaea;
  font-size: 14px;
  transition: background 0.2s ease;
}
.dropdown a:hover {
  background: #2e3238;
}
.show {
  display: block;
}
/* ===== GO BACK BUTTON ===== */
.go-back-container {
  text-align: left;
  padding: 16px 24px;
}
.go-back-btn {
  background: none;
  border: 1px solid var(--accent);
  color: var(--accent);
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}
.go-back-btn:hover {
  background: var(--accent);
  color: #fff;
}
/* ===== PROFILE FORM ===== */
.profile-container {
  max-width: 500px;
  margin: 20px auto;
  padding: 24px;
  background: #1d1f23;
  border-radius: 8px;
  box-shadow: 0 2px 8px var(--shadow);
}
.profile-container h2 {
  margin-top: 0;
  color: var(--accent);
}
.profile-container label {
  display: block;
  margin-top: 15px;
  font-weight: 500;
}
.profile-container input {
  width: 100%;
  padding: 10px;
  margin-top: 5px;
  border-radius: 4px;
  border: 1px solid #444;
  background: #121417;
  color: var(--header-text);
  box-sizing: border-box;
}
/* Style for static (disabled) fields */
.profile-container input:disabled {
  background: #1a1c20;
  border: 1px solid #333;
  color: #aaa;
  cursor: not-allowed;
  opacity: 0.8;
}
.name-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 80px;
  gap: 10px;
}
.input-wrapper {
  position: relative;
}
.toggle-eye {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  font-size: 16px;
  color: var(--accent);
  user-select: none;
}
.profile-container button {
  margin-top: 20px;
  padding: 12px 20px;
  background: var(--accent);
  border: none;
  color: #fff;
  cursor: pointer;
  border-radius: 6px;
  font-weight: 600;
  width: 100%;
}
.profile-container button:hover {
  opacity: 0.8;
}
/* ===== CUSTOM MODAL ===== */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(3px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-box {
  background: #1d1f23;
  padding: 24px;
  border-radius: 10px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.7);
  max-width: 400px;
  width: 90%;
  text-align: center;
  color: #fff;
  border: 1px solid #333;
}
.modal-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 10px;
  color: var(--accent);
}
.modal-message {
  margin: 15px 0;
  line-height: 1.5;
}
.modal-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 20px;
}
.modal-box button {
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  border: none;
  min-width: 80px;
}
.modal-confirm {
  background: var(--accent);
  color: #fff;
}
.modal-cancel {
  background: #444;
  color: #fff;
}
.modal-ok {
  background: var(--accent);
  color: #fff;
  width: 100%;
}
/* Success and Error specific styles */
.modal-success .modal-title {
  color: #4CAF50;
}
.modal-error .modal-title {
  color: #f44336;
}
</style>
</head>
<body>
<header>
  <div class="logo">VoteEase</div>
  <div class="menu">
    <div class="menu-links"></div>
    <button class="menu-btn" onclick="toggleMenu()">
      <div></div><div></div><div></div>
    </button>
    <div class="dropdown" id="dropdownMenu">
      <a href="profile.html">Profile</a>
      <a href="contactus.html">Contact Us</a>
      <a href="about.html">About</a>
      <a href="privacypolicy.html">Privacy Policy</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>
  </div>
</header>
<div class="go-back-container">
  <button class="go-back-btn" onclick="goBack()">‚Üê Go Back</button>
</div>
<div class="profile-container">
  <h2>Update Profile</h2>
  <form id="profileForm">
    <div class="name-grid">
      <div>
        <label>Last Name:</label>
        <input type="text" id="lastname" required>
      </div>
      <div>
        <label>First Name:</label>
        <input type="text" id="firstname" required>
      </div>
      <div>
        <label>M.I.:</label>
        <input type="text" id="mi" maxlength="1">
      </div>
    </div>
    <label>Email:</label>
    <input type="email" id="email" required>
    <label>Address:</label>
    <input type="text" id="address" required disabled>
    <label>Phone:</label>
    <input type="text" id="phone" required disabled>
    <label>Current Password:</label>
    <div class="input-wrapper">
      <input type="password" id="current_password" required>
      <span class="toggle-eye" onmousedown="holdEye('current_password')" onmouseup="releaseEye('current_password')" onmouseleave="releaseEye('current_password')">&#128065;</span>
    </div>
    <label>New Password:</label>
    <div class="input-wrapper">
      <input type="password" id="password">
      <span class="toggle-eye" onmousedown="holdEye('password')" onmouseup="releaseEye('password')" onmouseleave="releaseEye('password')">&#128065;</span>
    </div>
    <label>Confirm Password:</label>
    <div class="input-wrapper">
      <input type="password" id="confirm_password">
      <span class="toggle-eye" onmousedown="holdEye('confirm_password')" onmouseup="releaseEye('confirm_password')" onmouseleave="releaseEye('confirm_password')">&#128065;</span>
    </div>
    <button type="submit">Save Changes</button>
  </form>
</div>
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-box" id="modalBox">
    <div class="modal-title" id="modalTitle">Confirmation</div>
    <div class="modal-message" id="modalMessage">Are you sure you want to save changes?</div>
    <div class="modal-buttons" id="modalButtons">
      <button class="modal-confirm" onclick="confirmModal()">Yes</button>
      <button class="modal-cancel" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>
<script>
function toggleMenu() { document.getElementById("dropdownMenu").classList.toggle("show"); }
window.onclick = function(e) { if (!e.target.matches('.menu-btn') && !e.target.closest('.menu')) { document.getElementById("dropdownMenu").classList.remove("show"); } };
function logout() { 
  localStorage.removeItem("user"); 
  window.location.href = "/voting_system/index.html"; 
}
function goBack() {  window.location.href = "http://localhost/voting_system/dashboard.html";}

// ===== Eye hold logic =====
function holdEye(id) { const input = document.getElementById(id); input.type = "text"; }
function releaseEye(id) { const input = document.getElementById(id); input.type = "password"; }

// ===== MODAL LOGIC =====
let modalCallback = null;

function showModal(callback, title = "Confirmation", message = "Are you sure you want to save changes?", type = "confirm") {
  modalCallback = callback;
  const modalBox = document.getElementById("modalBox");
  const modalTitle = document.getElementById("modalTitle");
  const modalMessage = document.getElementById("modalMessage");
  const modalButtons = document.getElementById("modalButtons");
  
  // Set title and message
  modalTitle.textContent = title;
  modalMessage.textContent = message;
  
  // Set modal type (confirm, success, error)
  modalBox.className = "modal-box";
  if (type === "success") {
    modalBox.classList.add("modal-success");
  } else if (type === "error") {
    modalBox.classList.add("modal-error");
  }
  
  // Set buttons based on type
  if (type === "confirm") {
    modalButtons.innerHTML = `
      <button class="modal-confirm" onclick="confirmModal()">Yes</button>
      <button class="modal-cancel" onclick="closeModal()">Cancel</button>
    `;
  } else {
    modalButtons.innerHTML = `
      <button class="modal-ok" onclick="closeModal()">OK</button>
    `;
  }
  
  document.getElementById("modalOverlay").style.display = "flex";
}

function showSuccess(message) {
  showModal(null, "Success", message, "success");
}

function showError(message) {
  showModal(null, "Error", message, "error");
}

function closeModal() {
  document.getElementById("modalOverlay").style.display = "none";
}

function confirmModal() {
  closeModal();
  if (modalCallback) modalCallback();
}

// Function to parse name from "Lastname, Firstname M.I." format
function parseName(fullName) {
  if (!fullName) return { lastname: '', firstname: '', mi: '' };
  
  if (fullName.includes(',')) {
    const parts = fullName.split(',');
    const lastname = parts[0].trim();
    const firstAndMI = parts[1].trim().split(' ');
    const firstname = firstAndMI[0] || '';
    const mi = firstAndMI[1] || '';
    return { lastname, firstname, mi };
  } else {
    const parts = fullName.split(' ');
    const lastname = parts[0] || '';
    const firstname = parts[1] || '';
    const mi = parts[2] || '';
    return { lastname, firstname, mi };
  }
}

// Function to format name for database
function formatName(lastname, firstname, mi) {
  if (mi) {
    return `${lastname}, ${firstname} ${mi}`;
  } else {
    return `${lastname}, ${firstname}`;
  }
}

// ===== PROFILE LOGIC =====
document.addEventListener("DOMContentLoaded", ()=>{
  const user = JSON.parse(localStorage.getItem("user")||"{}");
  console.log("User data from localStorage:", user);
  
  if(!user.id){
    showError("User not logged in.");
    setTimeout(() => {
      window.location.href="index.html";
    }, 2000);
    return;
  }
  
  // Parse and prefill name fields
  const { lastname, firstname, mi } = parseName(user.name || "");
  document.getElementById("lastname").value = lastname;
  document.getElementById("firstname").value = firstname;
  document.getElementById("mi").value = mi;
  
  // Prefill other inputs
  document.getElementById("email").value = user.email || "";
  document.getElementById("address").value = user.address || "";
  document.getElementById("phone").value = user.phone || "";
  
  console.log("Address:", user.address);
  console.log("Phone:", user.phone);

  const form = document.getElementById("profileForm");
  form.addEventListener("submit",(e)=>{
    e.preventDefault();
    showModal(()=>updateProfile(user), "Confirm Changes", "Are you sure you want to save your profile changes?");
  });
});

async function updateProfile(user){
  const lastname = document.getElementById("lastname").value.trim();
  const firstname = document.getElementById("firstname").value.trim();
  const mi = document.getElementById("mi").value.trim();
  
  // Format name for database
  const name = formatName(lastname, firstname, mi);
  
  const payload = {
    id: user.id,
    current_password: document.getElementById("current_password").value,
    name: name,
    email: document.getElementById("email").value,
    address: document.getElementById("address").value,
    phone: document.getElementById("phone").value,
    password: document.getElementById("password").value,
    confirm_password: document.getElementById("confirm_password").value
  };
  
  console.log("Sending payload:", payload);
  
  try {
    const res = await fetch("../../backend/profile.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const text = await res.text();
    console.log("Raw response:", text);
    
    let data;
    try {
      data = JSON.parse(text);
    } catch (parseError) {
      console.error("JSON parse error:", parseError);
      showError("Server returned invalid response. Please try again.");
      return;
    }
    
    console.log("Parsed response:", data);

    if(data.status === "error") {
      showError(data.message);
      return;
    }

    if(data.status === "success") {
      showSuccess(data.message);
      // Update local storage with new user data
      if(data.user) {
        user.name = data.user.name;
        user.email = data.user.email;
        user.address = data.user.address;
        user.phone = data.user.phone;
        localStorage.setItem("user", JSON.stringify(user));
        
        // Update form fields with new data
        const { lastname, firstname, mi } = parseName(user.name || "");
        document.getElementById("lastname").value = lastname;
        document.getElementById("firstname").value = firstname;
        document.getElementById("mi").value = mi;
        document.getElementById("email").value = user.email;
        document.getElementById("address").value = user.address;
        document.getElementById("phone").value = user.phone;
        
        // Clear password fields
        document.getElementById("password").value = "";
        document.getElementById("confirm_password").value = "";
        document.getElementById("current_password").value = "";
        
        console.log("Updated user data:", user);
      }
    }
  } catch (err) {
    showError("Error updating profile: " + err.message);
    console.error("Full error:", err);
  }
}
</script>
</body>
</html>